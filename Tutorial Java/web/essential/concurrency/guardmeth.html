<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Bloques Vigilados (Los Tutoriales de Java&trade; &gt; Clases Esenciales &gt; Concurrencia)
        </title>
        <meta name="description" content="Este tutorial de Java describe las excepciones, la entrada/salida básica, concurrencia,
              expresiones regulares, y el entorno de la plataforma" />
        <meta name="keywords" content="java programming, learn java, java sample code, java exception, java input output, java
              threads, java regex, regular expressions, path, classpath, environment variable" />
        <link rel="stylesheet" href="../../indice.css" type="text/css"/>
        <script src="../../navegacion.js"></script>
    </head>
    <body onload="load()">
        <noscript>Se requiere un navegador con JavaScript habilitado para que esta página opere apropiadamente.</noscript>
        <div class="header-container">
            <div class="bookwrapper clearfix">
                <div id="brandProdName">
                    <div id="logocover"></div>
                    <div id="productName">Documentación</div>
                </div>
                <br class="clearfloat" />
            </div>
        </div>
        <div id="TopBar">
            <div id="TopBar_tr">
                <div id="TopBar_tl">
                    <div id="TopBar_br">
                        <div id="TopBar_bl">
                            <div id="TopBar_left">Los Tutoriales de Java&trade;</div>
                            <div id="TopBar_right">
                                <a target="_blank" href="http://www.oracle.com/technetwork/java/javase/downloads/java-se-7-tutorial-2012-02-28-1536013.html">
                                    Descargar Libros Electrónicos</a><br />
                                <a target="_blank" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">
                                    Descargar KDJ</a><br />
                                <a href="javascript:toggleLeft()" id="ToggleLeft">
                                    Ocultar TdC</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="LeftBar" class="LeftBar_shown">
            <div id="Contents">
                <div class="linkLESSON"><a href="index.html">Concurrencia</a></div>
                <div class="linkAHEAD"><a href="procthread.html">Procesos e Hilos</a></div>
                <div class="linkAHEAD"><a href="threads.html">Objetos Hilo</a></div>
                <div class="linkBHEAD"><a href="runthread.html">Definiendo e Iniciando un Hilo</a></div>
                <div class="linkBHEAD"><a href="sleep.html">Pausando la Ejecución con Sleep</a></div>
                <div class="linkBHEAD"><a href="interrupt.html">Interrupciones</a></div>
                <div class="linkBHEAD"><a href="join.html">Uniones</a></div>
                <div class="linkBHEAD"><a href="simple.html">El Ejemplo SimpleThreads</a></div>
                <div class="linkAHEAD"><a href="sync.html">Sincronización</a></div>
                <div class="linkBHEAD"><a href="interfere.html">Interferencias entre Hilos</a></div>
                <div class="linkBHEAD"><a href="memconsist.html">Errores de Consistencia en Memoria</a></div>
                <div class="linkBHEAD"><a href="syncmeth.html">Métodos Sincronizados</a></div>
                <div class="linkBHEAD"><a href="locksync.html">Bloqueos Intrínsecos y Sincronización</a></div>
                <div class="linkBHEAD"><a href="atomic.html">Acceso Atómico</a></div>
                <div class="linkAHEAD"><a href="liveness.html">Tiempo de vida</a></div>
                <div class="linkBHEAD"><a href="deadlock.html">Bloqueo Mutuo</a></div>
                <div class="linkBHEAD"><a href="starvelive.html">Inanición y Livelock</a></div>
                <div class="nolinkAHEAD">Bloques Vigilados</div>
                <div class="linkAHEAD"><a href="immutable.html">Objetos Inmutables</a></div>
                <div class="linkBHEAD"><a href="syncrgb.html">Un Ejemplo de Clase Sincronizada</a></div>
                <div class="linkBHEAD"><a href="imstrat.html">Una Estrategia para Definir Objetos Inmutables</a></div>
                <div class="linkAHEAD"><a href="highlevel.html">Objetos con Alto Nivel de Concurrencia</a></div>
                <div class="linkBHEAD"><a href="newlocks.html">Objetos de Bloqueo</a></div>
                <div class="linkBHEAD"><a href="executors.html">Ejecutores</a></div>
                <div class="linkCHEAD"><a href="exinter.html">Interfaces del Ejecutor</a></div>
                <div class="linkCHEAD"><a href="pools.html">Agrupaciones de Hilos</a></div>
                <div class="linkCHEAD"><a href="forkjoin.html">Fork/Join</a></div>
                <div class="linkBHEAD"><a href="collections.html">Colecciones Concurrentes</a></div>
                <div class="linkBHEAD"><a href="atomicvars.html">Variables Atómicas</a></div>
                <div class="linkBHEAD"><a href="threadlocalrandom.html">Números Aleatorios Concurrentes</a></div>
                <div class="linkAHEAD"><a href="further.html">Lecturas Adicionales</a></div>
                <div class="linkQUESTIONS"><a href="QandE/questions.html">Preguntas y Ejercicios</a></div>
            </div>
        </div>
        <div id="MainFlow" class="MainFlow_indented">
            <div class="PrintHeaders">
                <b>Recorrido:</b> Clases Esenciales<br />
                <b>Lección:</b> Concurrencia
            </div>
            <div id="BreadCrumbs">
                <a href="../../index.html" target="_top">Página de Inicio</a>&nbsp;&gt;&nbsp;
                <a href="../index.html" target="_top">Clases Esenciales</a>&nbsp;&gt;&nbsp;
                <a href="index.html" target="_top">Concurrencia</a>
            </div>
            <div class="NavBit">
                <a target="_top" href="starvelive.html">&laquo;&nbsp;Anterior</a>&nbsp;&bull;&nbsp;
                <a target="_top" href="../TOC.html">TdC</a>&nbsp;&bull;&nbsp;
                <a target="_top" href="immutable.html">Siguiente&nbsp;&raquo;</a>
            </div>
            <div id="PageTitle">
                <h1>Bloques Vigilados</h1>
            </div>
            <div id="PageContent">
                <p>
                    Los hilos a menudo tienen que coordinar sus acciones. El idioma de coordinación más común es el de 
                    <i>bloques vigilados</i>.
                    Dicho bloque comienza por sondear una condición que debe ser verdadera antes de que el bloque pueda continuar.
                    Hay un número de pasos a seguir en orden a hacer esto correctamente.
                </p>
                <p>
                    Suponga, por ejemplo <code>guardedJoy</code> es un método que no procede hasta que una variable compartida
                    <code>joy</code> ha sido establecida por otro hilo. Dicho método podría, en teoría, simplemente hacer un bucle
                    hasta que la condición se satisfaga, pero ese bucle es un despilfarro, ya que se ejecuta continuamente mientras
                    se espera.
                </p>
                <div class="codeblock">
                    <pre>
public void guardedJoy() {
    // Bucle simple de vigilancia. Gasta
    // tiempo de procesador. ¡No haga esto!
    while(!joy) {}
    System.out.println("¡La alegría se ha conseguido!");
}
                    </pre>
                </div>
                <p>
                    Una protección más eficiente invoca
                    <a class="APILink" target="_blank" 
                       href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait--">
                        <code>Object.wait</code></a> para suspender el hilo actual. La invocación de <code>wait</code> no vuelve
                    hasta que otro hilo haya emitido una notificación de que algún evento especial puede haber ocurrido  &mdash;
                    aunque no necesariamente el evento por el que este hilo está esperando:
                </p>
                <div class="codeblock">
                    <pre>
public synchronized void guardedJoy() {
    // Esta protección solo hace un bucle por cada evento especial, el cual puede no
    // ser el evento por el que estamos esperando.
    while(!joy) {
        try {
            wait();
        } catch (InterruptedException e) {}
    }
    System.out.println("¡La alegría y eficiencia se han logrado!");
}
                    </pre>
                </div>
                <div class="note">
                    <hr />
                    <strong>Nota:</strong>&nbsp;Siempre invoque <code>wait</code> dentro de un bucle que compruebe la condición
                    por la que se está esperando. No asuma que la interrupción fue por la condición particular que usted estaba
                    esperando, o que la condición sea aún verdad.
                    <hr />
                </div>
                <p>
                    Como muchos métodos que suspenden la ejecución, <code>wait</code> puede lanzar
                    <code>InterruptedException</code>. En este ejemplo, nosotros ignoramos esa excepción &mdash; sólo nos importa
                    el valor de <code>joy</code>.
                </p>
                <p>
                    ¿Porqué es esta versión de <code>guardedJoy</code> sincronizada? Suponga que <code>d</code> es el objeto que
                    nosotros estamos usando para invocar <code>wait</code>. Cuando un hilo invoca <code>d.wait</code>, debe poseer
                    el bloque intrínseco para <code>d</code> &mdash; de otra forma se lanza un error. Invocar <code>wait</code>
                    dentro de un método sincronizado es una forma simple de adquirir el bloqueo intrínseco.
                </p>
                <p>
                    Cuando <code>wait</code> es invocado, el hilo libera el bloqueo y suspende su ejecución. En un tiempo futuro,
                    otro hilo adquirirá el mismo bloqueo e invocará
                    <a class="APILink" target="_blank" 
                       href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#notifyAll--">
                        <code>Object.notifyAll</code></a>, informando a todos los hilos que esperan ese bloqueo que algo importante
                    ha ocurrido:
                </p>
                <div class="codeblock">
                    <pre>
public synchronized notifyJoy() {
    joy = true;
    notifyAll();
}
                    </pre>
                </div>
                <p>
                    Algún tiempo después el segundo hilo ha liberado el bloqueo, el primer hilo readquiere el bloqueo y reanuda
                    volviendo desde la invocación de <code>wait</code>.
                </p>
                <div class="note">
                    <hr />
                    <strong>Nota:</strong>&nbsp;Hay un segundo método de notificación, <code>notify</code>, el cual despierta un
                    único hilo. Ya que <code>notify</code> no le permite especificar el hilo que se va a despertar, es útil sólo en
                    aplicaciones masivamente paralelas &mdash; esto es, porgramas con un gran número de hilos, todos haciendo tareas
                    similares. En tal aplicación , no le importa qué hilo se despierta.
                    <hr />
                </div>
                <p>
                    Usaremos bloques vigilados para crear una aplicación <i>Productor-Consumidor</i>. Esta clase de aplicación
                    comparte datos entre dos hilos: el <i>productor</i>, que crea los datos, y el <i>consumidor</i>, que hace algo
                    con ellos. Los dos hilos se comunican usando un objeto compartido. La coordinación es esencial: el hilo
                    consumidor no debe intentar recuperar el dato antes de que el hilo productor lo haya despachado, y el hilo
                    productor no debe despachar nuevos datos si el consumidor no ha recuperado los viejos datos.
                </p>
                <p>
                    En este ejemplo, los datos son una serie de mensajes de texto, los cuales son compartidos a través de un objeto
                    de tipo
                    <a class="SourceLink" target="_blank"
                       href="examples/Gota.java" onclick="showCode('../../displayCode.html', 'examples/Gota.java'); return false;">
                        <code>Gota</code></a>:
                </p>
                <div class="codeblock">
                    <pre>

public class Gota {
    // Mensaje enviado del productor
    // al consumidor.
    private String mensaje;
    // Verdadero si el consumidor debe esperar
    // para que el productor envíe un mensaje,
    // falso si el productor debe esperar para
    // que el consumidor recupere el mensaje.
    private boolean estaVacio = true;

    public synchronized String tomar() {
        // Esperar hasta que el mensaje esté
        // disponible.
        while (estaVacio) {
            try {
                wait();
            } catch (InterruptedException e) {}
        }
        // Cambia el estado.
        estaVacio = true;
        // Notifica al productor que el
        // estado ha cambiado.
        notifyAll();
        return mensaje;
    }

    public synchronized void poner(String mensaje) {
        // Esperar hasta que el mensaje ha
        // sido recuperado.
        while (!estaVacio) {
            try {
                wait();
            } catch (InterruptedException e) {}
        }
        // Cambia el estado.
        estaVacio = false;
        // Almacena el mensaje.
        this.mensaje = mensaje;
        // Notifica al consumidor que el estado
        // ha cambiado.
        notifyAll();
    }
}

                    </pre>
                </div>
                <p>
                    El hilo productor, definido en
                    <a class="SourceLink" target="_blank" href="examples/Productor.java"
                       onclick="showCode('../../displayCode.html', 'examples/Productor.java'); return false;">
                        <code>Productor</code></a>, envía una serie de mensajes familiares. La cadena &quot;HECHO&quot; indica que
                    todos los mensajes han sido enviados. Para simular la naturaleza impredecible de las aplicaciones del
                    mundo real, el hilo productor se para por intervalos de tiempo aleatorios entre mensajes.
                </p>
                <div class="codeblock">
                    <pre>

import java.util.Random;

public class Productor implements Runnable {

    private Gota gota;

    public Productor(Gota gota) {
        this.gota = gota;
    }

    public void run() {
        String infoImportante[] = {
            "Las yeguas comen avena",
            "Los conejos comen avena",
            "Los pequeños corderos comen hiedra",
            "Un niño también comerá hiedra"
        };
        Random aleatorio = new Random();

        for (int i = 0;
                i &lt; infoImportante.length;
                i++) {
            gota.poner(infoImportante[i]);
            try {
                Thread.sleep(aleatorio.nextInt(5000));
            } catch (InterruptedException e) {
            }
        }
        gota.poner("HECHO");
    }
}
                    </pre>
                </div>
                <p>
                    El hilo consumidor, definido en
                    <a class="SourceLink" target="_blank" href="examples/Consumidor.java"
                       onclick="showCode('../../displayCode.html', 'examples/Consumidor.java'); return false;">
                        <code>Consumidor</code></a>, simplemente recupera los mensajes y los imprime, hasta que recupera
                    la cadena &quot;HECHO&quot;. Este hilo también se para por intervalos aleatorios.
                </p>
                <div class="codeblock">
                    <pre>

import java.util.Random;

public class Consumidor implements Runnable {
    private Gota gota;

    public Consumidor(Gota gota) {
        this.gota = gota;
    }

    public void run() {
        Random aleatorio = new Random();
        for (String mensaje = gota.tomar();
             ! mensaje.equals("HECHO");
             mensaje = gota.tomar()) {
            System.out.format("MENSAJE RECIBIDO: %s%n", mensaje);
            try {
                Thread.sleep(aleatorio.nextInt(5000));
            } catch (InterruptedException e) {}
        }
    }
}
                    </pre>
                </div>
                <p>
                    Finalmente, aquí tenemos el hilo principal, definido en
                    <a class="SourceLink" target="_blank" href="examples/EjemploProductorConsumidor.java"
                       onclick="showCode('../../displayCode.html', 'examples/EjemploProductorConsumidor.java'); return false;">
                        <code>EjemploProductorConsumidor.java</code></a>, que lanza los hilos productor y consumidor.
                </p>
                <div class="codeblock">
                    <pre>

public class EjemploProductorConsumidor {
    public static void main(String[] args) {
        Gota gota = new Gota();
        (new Thread(new Productor(gota))).start();
        (new Thread(new Consumidor(gota))).start();
    }
}
                    </pre>
                </div>
                <div class="note">
                    <hr />
                    <strong>Nota:</strong>&nbsp;La clase <code>Gota</code> fue escrita con el fin de demostrar los bloques
                    vigilados. Para evitar re-inventar la rueda, examine las estructuras de datos existentes en el
                    <a class="TutorialLink" target="_top" href="../../collections/index.html">
                        Marco de trabajo de Colecciones de Java</a> antes de intentar codificar sus propios objetos de compartición
                    de datos. Para obtener más información, refíerase a la sección de 
                    <a href="QandE/questions.html">Preguntas y Ejercicios</a>.
                    <hr />
                </div>
            </div>
            <div class="NavBit">
                <a target="_top" href="starvelive.html">&laquo;&nbsp;Anterior</a>&nbsp;&bull;&nbsp;
                <a target="_top" href="../TOC.html">TdC</a>&nbsp;&bull;&nbsp;
                <a target="_top" href="immutable.html">Siguiente&nbsp;&raquo;</a>
            </div>
        </div>
        <hr class="clearfloat"/>
        <div id="Footer">
            <table style="width: 100%;padding: 5px">
                <tr>
                    <td>
                        <p class="footertext">
                            <a id="license_info">Su uso de ésta</a> página y todo el material en las páginas bajo el anuncio
                            &quot;Los Tutoriales de Java&quot; está sujeto a estos <a href="../../information/cpyr.html">avisos
                                legales</a>.
                        </p>
                        <p class="footertext">
                            Copyright &copy; 1995, 2015 Oracle y/o sus afiliados. Todos los derechos reservados.
                        </p>
                    </td>
                    <td style="text-align: right">
                        <p class="footertext">
                            ¿Problemas con estos ejemplos? Intente <a target="_blank" href="../../information/run-examples.html">
                                Compilando y Ejecutando los Ejemplos: PFs</a>.
                        </p>
                        <p class="footertext">
                            ¿Quejas? ¿Elogios? ¿Sugerencias? <a target="_blank" href="https://docs.oracle.com/javase/feedback.html">
                                Denos su opinión</a>.
                        </p>
                    </td>
                </tr>
            </table>
        </div>
        <div class="PrintHeaders">
            <b>Página Anterior:</b> Inanición y Livelock<br />
            <b>Página Siguiente:</b> Objetos Inmutables
        </div>
    </body>
</html>