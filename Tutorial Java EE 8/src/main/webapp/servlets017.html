<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <title>La Aplicación de Ejemplo dukeetf</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
    <table id="doc-title" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top">
          <b>Plataforma Java, Edición Empresarial (Java EE) 8</b><br />
          <b>El Tutorial de Java EE</b>
        </td>
      </tr>
    </table>
    <hr />
    <table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>
        <td align="left">
          <a href="servlets016.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="servlets018.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <div class="sect1" id="CHDBBEDA">
      <h2 id="the-dukeetf-example-application">La Aplicación de Ejemplo dukeetf</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>
            La aplicación de ejemplo <code>dukeetf</code>, ubicada en el directorio 
            tut-install`/examples/web/dukeetf/`, demuestra cómo utilizar el procesamiento asíncrono en un 
            servlet para proporcionar actualizaciones de datos a los clientes web. El ejemplo se asemeja a un 
            servicio que proporciona actualizaciones periódicas sobre el precio y el volumen de negociación de 
            un fondo negociado electrónicamente (ETF).
          </p>
        </div>
        <div class="paragraph">
          <p>Aquí se tratan los siguientes temas:</p>
        </div>
        <div class="ulist">
          <ul>
            <li>
              <p><a href="#CHDBBEDA">Arquitectura de la Aplicación de Ejemplo dukeetf</a></p>
            </li>
            <li>
              <p><a href="#CHDHBBBI">Ejecutando la Aplicación de Ejemplo dukeetf</a></p>
            </li>
          </ul>
        </div>
        <div class="sect2" id="CHDBBEDA">
          <h3 id="architecture-of-the-dukeetf-example-application">
            Arquitectura de la Aplicación de Ejemplo dukeetf
          </h3>
          <div class="paragraph">
            <p>
              La aplicación de ejemplo <code>dukeetf</code> consta de un servlet, un bean empresarial y una 
              página HTML.
            </p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p>
                  El servlet pone las solicitudes en modo asíncrono, las almacena en una cola y escribe las 
                  respuestas cuando hay nuevos datos disponibles para el precio y el volumen de operaciones.
                </p>
              </li>
              <li>
                <p>El Enterprise bean actualiza la información de precio y volumen una vez por segundo.</p>
              </li>
              <li>
                <p>
                  La página HTML utiliza código JavaScript para realizar solicitudes al servlet de nuevos 
                  datos, analizar la respuesta del servlet y actualizar la información de precio y volumen sin 
                  recargar la página.
                </p>
              </li>
            </ul>
          </div>
          <div class="paragraph">
            <p>
              La aplicación de ejemplo <code>dukeetf</code> utiliza un modelo de programación conocido como 
              sondeo largo. En el modelo tradicional de solicitud y respuesta HTTP, el usuario debe realizar 
              una solicitud explícita (como hacer clic en un enlace o enviar un formulario) para obtener 
              información nueva del servidor, y la página debe volver a cargarse. El sondeo largo proporciona 
              un mecanismo para que las aplicaciones web envíen actualizaciones a los clientes mediante HTTP 
              sin que el usuario realice una solicitud explícita. El servidor maneja las conexiones de forma 
              asincrónica y el cliente usa JavaScript para realizar nuevas conexiones. En este modelo, los 
              clientes realizan una nueva solicitud inmediatamente después de recibir nuevos datos y el 
              servidor mantiene abierta la conexión hasta que haya nuevos datos disponibles.
            </p>
          </div>
          <div class="sect3" id="sthref111">
            <h4 id="the-servlet">El Servlet</h4>
            <div class="paragraph">
              <p>La clase <code>DukeETFServlet</code> utiliza procesamiento asíncrono:</p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@WebServlet(urlPatterns={"/dukeetf"}, asyncSupported=true)
public class DukeETFServlet extends HttpServlet {
...
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                En el siguiente código, el método <code>init</code> inicializa una cola para contener 
                solicitudes de clientes y registra el servlet con el bean empresarial que proporciona las 
                actualizaciones de precio y volumen. El método <code>send</code> es llamado una vez por 
                segundo por el <code>PriceVolumeBean</code> para enviar actualizaciones y cerrar la conexión:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@Override
public void init(ServletConfig config) {
   /* Cola de solicitudes */
   requestQueue = new ConcurrentLinkedQueue&lt;&gt;();
   /* Regístrese con el bean empresarial que proporciona actualizaciones de precio/volumen */
   pvbean.registerServlet(this);
}
/* PriceVolumeBean llama a este método cada segundo para enviar actualizaciones */
public void send(double price, int volume) {
   /* Envía la actualización a todos los clientes conectados */
   for (AsyncContext acontext : requestQueue) {
      try {
         String msg = String.format("%.2f / %d", price, volume);
         PrintWriter writer = acontext.getResponse().getWriter();
         writer.write(msg);
         logger.log(Level.INFO, "Enviado: {0}", msg);
         /* Cierra la conexión
          * El cliente (JavaScript) hace una nueva instantáneamente*/
         acontext.complete();
      } catch (IOException ex) {
         logger.log(Level.INFO, ex.toString());
      }
   }
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                El método de servicio pone las solicitudes de los clientes en modo asíncrono y agrega un 
                oyente a cada solicitud. El oyente se implementa como una clase anónima que elimina la 
                solicitud de la cola cuando el servlet termina de escribir una respuesta o cuando hay un 
                error. Finalmente, el método de servicio agrega la solicitud a la cola de solicitudes creada 
                en el método <code>init</code>. El método de servicio es el siguiente:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@Override
public void doGet(HttpServletRequest request,
                  HttpServletResponse response) {
   response.setContentType("text/html");
   /* Pone la solicitud en modo asíncrono */
   final AsyncContext acontext = request.startAsync();
   /* Elimina de la cola cuando haya terminado */
   acontext.addListener(new AsyncListener() {
      public void onComplete(AsyncEvent ae) throws IOException {
         requestQueue.remove(acontext);
      }
      public void onTimeout(AsyncEvent ae) throws IOException {
         requestQueue.remove(acontext);
      }
      public void onError(AsyncEvent ae) throws IOException {
         requestQueue.remove(acontext);
      }
      public void onStartAsync(AsyncEvent ae) throws IOException {}
   });
   /* Añade a la cola */
   requestQueue.add(acontext);
}
                  </code>
                </pre>
              </div>
            </div>
          </div>
          <div class="sect3" id="sthref112">
            <h4 id="the-enterprise-bean">El Enterprise Bean</h4>
            <div class="paragraph">
              <p>
                La clase <code>PriceVolumeBean</code> es un bean empresarial que utiliza el servicio de 
                temporizador del contenedor para actualizar la información de precio y volumen y llamar al 
                método <code>send</code> del servlet una vez por segundo:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@Startup
@Singleton
public class PriceVolumeBean {
    /* Usa el servicio de temporizador del contenedor */
    @Resource TimerService tservice;
    private DukeETFServlet servlet;
    ...
    @PostConstruct
    public void init() {
        /* Inicializa el EJB y crea un temporizador */
        random = new Random();
        servlet = null;
        tservice.createIntervalTimer(1000, 1000, new TimerConfig());
    }
    public void registerServlet(DukeETFServlet servlet) {
        /* Asociar un servlet para enviarle actualizaciones */
        this.servlet = servlet;
    }
    @Timeout
    public void timeout() {
        /* Ajusta el precio y el volumen y envía las actualizaciones */
        price += 1.0*(random.nextInt(100)-50)/100.0;
        volume += random.nextInt(5000) - 2500;
        if (servlet != null)
            servlet.send(price, volume);
    }
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Vea <a href="ejb-basicexamples005.html#BNBOY">Usando el Servicio de Temporizador</a> en 
                <a href="ejb-basicexamples.html#GIJRB">
                  Capítulo 37, "Ejecutando los Ejemplos de Enterprise Bean"</a> para obtener más información 
                  sobre el servicio de temporizador.
              </p>
            </div>
          </div>
          <div class="sect3" id="sthref113">
            <h4 id="the-html-page">La Página HTML</h4>
            <div class="paragraph">
              <p>
                La página HTML consta de una tabla y algo de código JavaScript. La tabla contiene dos campos a 
                los que se hace referencia desde el código JavaScript:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head&gt;...&lt;/head&gt;
&lt;body onload="makeAjaxRequest();"&gt;
  ...
  &lt;table&gt;
    ...
    &lt;td id="price"&gt;--.--&lt;/td&gt;
    ...
    &lt;td id="volume"&gt;--&lt;/td&gt;
    ...
  &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                El código JavaScript utiliza la IPA de <code>XMLHttpRequest</code>, que proporciona 
                funcionalidad para transferir datos entre un cliente y un servidor. El script realiza una 
                solicitud asíncrona al servlet y designa un método de devolución de llamada. Cuando el 
                servidor proporciona una respuesta, el método de devolución de llamada actualiza los campos de 
                la tabla y realiza una nueva solicitud. El código JavaScript es el siguiente:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
var ajaxRequest;
function updatePage() {
   if (ajaxRequest.readyState === 4) {
      var arraypv = ajaxRequest.responseText.split("/");
      document.getElementById("price").innerHTML = arraypv[0];
      document.getElementById("volume").innerHTML = arraypv[1];
      makeAjaxRequest();
   }
}
function makeAjaxRequest() {
   ajaxRequest = new XMLHttpRequest();
   ajaxRequest.onreadystatechange = updatePage;
   ajaxRequest.open("GET", "http://localhost:8080/dukeetf/dukeetf",
                    true);
   ajaxRequest.send(null);
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                La IPA de <code>XMLHttpRequest</code> es compatible con la mayoría de los navegadores modernos 
                y se usa ampliamente en el desarrollo de clientes web Ajax (JavaScript asíncrono y XML).
              </p>
            </div>
            <div class="paragraph">
              <p>
                Vea <a href="websocket011.html#BABGCEHE">La Aplicación de Ejemplo dukeetf2</a> en 
                <a href="websocket.html#GKJIQ5">Capítulo 19, "IPA de Java para WebSocket"</a> para obtener una 
                versión equivalente de este ejemplo implementado mediante un punto final de WebSocket.
              </p>
            </div>
          </div>
        </div>
        <div class="sect2" id="CHDHBBBI">
          <h3 id="running-the-dukeetf-example-application">Ejecutando la Aplicación de Ejemplo dukeetf</h3>
          <div class="paragraph">
            <p>
              Esta sección describe cómo ejecutar la aplicación de ejemplo <code>dukeetf</code> utilizando el 
              EID de NetBeans y desde la línea de comandos.
            </p>
          </div>
          <div class="paragraph">
            <p>Aquí se tratan los siguientes temas:</p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p><a href="#CHDCGCJD">Para Ejecutar la Aplicación de Ejemplo dukeetf Usando el EID NetBeans</a></p>
              </li>
              <li>
                <p><a href="#CHDHHAFG">Para Ejecutar la Aplicación de Ejemplo dukeetf Usando Maven</a></p>
              </li>
            </ul>
          </div>
          <div class="sect3" id="CHDCGCJD">
            <h4 id="to-run-the-dukeetf-example-application-using-netbeans-ide">
              Para Ejecutar la Aplicación de Ejemplo dukeetf Usando el EID NetBeans
            </h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>
                    Asegúrese de que el Servidor GlassFish se haya iniciado (consulte 
                    <a href="usingexamples002.html#BNADI">Arrancando y Parando el Servidor GlassFish</a>).
                  </p>
                </li>
                <li>
                  <p>En el menú Archivo, elija Abrir Proyecto.</p>
                </li>
                <li>
                  <p>En el cuadro de diálogo Abrir Proyecto, vaya a:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
tut-install/examples/web/servlet
                        </code>
                      </pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Seleccione la carpeta <code>dukeetf</code>.</p>
                </li>
                <li>
                  <p>Haga clic en Abrir Proyecto.</p>
                </li>
                <li>
                  <p>
                    En la pestaña Proyectos, haga clic con el botón derecho en el proyecto 
                    <code>dukeetf</code> y seleccione Ejecutar.
                  </p>
                  <div class="paragraph">
                    <p>
                      Este comando compila y empaqueta la aplicación en un archivo WAR 
                      (<code>dukeetf.war</code>) ubicado en el directorio <code>target</code>, lo implementa 
                      en el servidor y abre una ventana del navegador web con la siguiente URL:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
http://localhost:8080/dukeetf/
                        </code>
                      </pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      Abra la misma URL en un navegador web diferente para ver cómo ambas páginas obtienen 
                      actualizaciones de precio y volumen simultáneamente.
                    </p>
                  </div>
                </li>
              </ol>
            </div>
          </div>
          <div class="sect3" id="CHDHHAFG">
            <h4 id="to-run-the-dukeetf-example-application-using-maven">
              Para Ejecutar la Aplicación de Ejemplo dukeetf Usando Maven
            </h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>
                    Asegúrese de que el Servidor GlassFish se haya iniciado (consulte 
                    <a href="usingexamples002.html#BNADI">Arrancando y Parando el Servidor GlassFish</a>).
                  </p>
                </li>
                <li>
                  <p>En una ventana de terminal, vaya a:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
tut-install/examples/web/servlet/dukeetf/
                        </code>
                      </pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Ingrese el siguiente comando para implementar la aplicación:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
mvn install
                        </code>
                      </pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Abra una ventana del navegador web y escriba la siguiente dirección:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
http://localhost:8080/dukeetf/
                        </code>
                      </pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      Abra la misma URL en un navegador web diferente para ver cómo ambas páginas obtienen 
                      actualizaciones de precio y volumen simultáneamente.
                    </p>
                  </div>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr />
    <table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>		
        <td align="left">
          <a href="servlets016.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="servlets018.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <span id="copyright">
      <a href="img/cpyr.adoc">
        <img src="img/oracle.gif" height="10" alt="Logo de Oracle" />&nbsp;			
        <span>
          Copyright&nbsp;&copy;&nbsp;2017,&nbsp;Oracle&nbsp;y/o&nbsp;sus&nbsp;afiliados.&nbsp;Todos&nbsp;los&nbsp;
          derechos&nbsp;reservados.
        </span>
      </a>
    </span>
  </body>
</html>
