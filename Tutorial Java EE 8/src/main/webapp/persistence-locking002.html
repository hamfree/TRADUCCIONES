<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <title>Modos de Bloqueo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
    <table id="doc-title" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top">
          <b>Plataforma Java, Edición Empresarial (Java EE) 8</b><br />
          <b>El Tutorial de Java EE</b>
        </td>
      </tr>
    </table>
    <hr />
    <table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>
        <td align="left">
          <a href="persistence-locking001.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="persistence-entitygraphs.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <div class="sect1" id="GKJIU">
      <h2 id="lock-modes">Modos de Bloqueo</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>
            La aplicación puede aumentar el nivel de bloqueo de una entidad especificando el uso de modos de 
            bloqueo. Los modos de bloqueo se pueden especificar para aumentar el nivel de bloqueo optimista o 
            para solicitar el uso de bloqueos pesimistas.
          </p>
        </div>
        <div class="paragraph">
          <p>
            El uso de modos de bloqueo optimista hace que el proveedor de persistencia verifique los atributos 
            de versión de las entidades que se leyeron (pero no se modificaron) durante una transacción, así 
            como las entidades que se actualizaron.
          </p>
        </div>
        <div class="paragraph">
          <p>
            El uso de modos de bloqueo pesimista especifica que el proveedor de persistencia adquirirá 
            inmediatamente bloqueos de lectura o escritura a largo plazo para los datos de la base de datos 
            correspondientes al estado de la entidad.
          </p>
        </div>
        <div class="paragraph">
          <p>
            Puede configurar el modo de bloqueo para una operación de entidad especificando uno de los modos 
            de bloqueo definidos en el tipo enumerado <code>javax.persistence.LockModeType</code>, enumerados 
            en la <a href="#GKJIE">Tabla 45-1 </a>.
          </p>
        </div>
        <div class="paragraph">
          <p><a id="sthref183"></a><a id="GKJIE"></a></p>
        </div>
        <div class="paragraph">
          <p><strong>Tabla 45-1 Modos de Bloqueo para Acceso de Entidad Concurrente</strong></p>
        </div>
        <table class="tableblock frame-all grid-all" style="width: 75%;">
          <colgroup>
            <col style="width: 33.3333%;">
            <col style="width: 66.6667%;">
          </colgroup>
          <tbody>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><strong>Modo de Bloqueo</strong></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><strong>Descripción</strong></p></td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><code>OPTIMISTIC</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Obtiene un bloqueo de lectura optimista para todas las entidades con atributos de versión.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><code>OPTIMISTIC_FORCE_INCREMENT</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Obtiene un bloqueo de lectura optimista para todas las entidades con atributos de versión e 
                  incremente el valor del atributo de versión.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><code>PESSIMISTIC_READ</code></p></td>
              <td class="tableblock halign-left valign-top">
                <div>
                  <div class="paragraph">
                    <p>
                      Obtiene inmediatamente un bloqueo de lectura a largo plazo en los datos para evitar que 
                      se modifiquen o eliminen. Otras transacciones pueden leer los datos mientras se mantiene 
                      el bloqueo, pero no pueden modificar ni eliminar los datos.
                    </p>
                  </div>
                  <div class="paragraph">
                    <p>
                      El proveedor de persistencia puede obtener un bloqueo de escritura de la base de datos 
                      cuando se solicitó un bloqueo de lectura, pero no viceversa.
                    </p>
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><code>PESSIMISTIC_WRITE</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Obtiene inmediatamente un bloqueo de escritura a largo plazo en los datos para evitar que se 
                  lean, modifiquen o eliminen.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock"><code>PESSIMISTIC_FORCE_INCREMENT</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Obtiene inmediatamente un bloqueo a largo plazo de los datos para evitar que se modifiquen o 
                  eliminen, e incrementa el atributo de versión de las entidades versionadas.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Sinónimo de <code>OPTIMISTIC</code>. El uso de <code>LockModeType.OPTIMISTIC</code> es 
                  preferible para las nuevas aplicaciones.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top"><p class="tableblock"><code>WRITE</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  Sinónimo de <code>OPTIMISTIC_FORCE_INCREMENT</code>. El uso de 
                  <code>LockModeType.OPTIMISTIC_FORCE_INCREMENT</code> es preferible para las nuevas 
                  aplicaciones.
                </p>
              </td>
            </tr>
            <tr>
              <td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
              <td class="tableblock halign-left valign-top">
                <p class="tableblock">
                  No se producirá ningún bloqueo adicional en los datos de la base de datos.
                </p>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="sect2" id="GKJIK">
          <h3 id="setting-the-lock-mode">Establecer el Modo de Bloqueo</h3>
          <div class="paragraph">
            <p>
              Para especificar el modo de bloqueo, utilice una de las siguientes técnicas:
            </p>
          </div>
          <div class="olist arabic">
            <ol class="arabic">
              <li>
                <p>
                  Llame al método <code>EntityManager.lock</code>, pasando uno de los modos de bloqueo:
                </p>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
EntityManager em = ...;
Person person = ...;
em.lock(person, LockModeType.OPTIMISTIC);
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
              <li>
                <p>
                  Llame a uno de los métodos <code>EntityManager.find</code> que toman el modo de bloqueo como 
                  parámetro:
                </p>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
EntityManager em = ...;
String personPK = ...;
Person person = em.find(Person.class, personPK,
    LockModeType.PESSIMISTIC_WRITE);
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
              <li>
                <p>
                  Llame a uno de los métodos <code>EntityManager.refresh</code> que toman el modo de bloqueo 
                  como parámetro:
                </p>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
EntityManager em = ...;
String personPK = ...;
Person person = em.find(Person.class, personPK);
...
em.refresh(person, LockModeType.OPTIMISTIC_FORCE_INCREMENT);
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
              <li>
                <p>
                  Llame al método <code>Query.setLockMode</code> o <code>TypedQuery.setLockMode</code>, 
                  pasando el modo de bloqueo como parámetro:
                </p>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
Query q = em.createQuery(...);
q.setLockMode(LockModeType.PESSIMISTIC_FORCE_INCREMENT);
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
              <li>
                <p>
                  Agregue un elemento <code>lockMode</code> a la anotación <code>@NamedQuery</code>:
                </p>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
@NamedQuery(name="lockPersonQuery",
  query="SELECT p FROM Person p WHERE p.name LIKE :name",
  lockMode=PESSIMISTIC_READ)
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="sect2" id="GKJIL">
          <h3 id="using-pessimistic-locking">Uso de bloqueo pesimista</h3>
          <div class="paragraph">
            <p>
              Las entidades versionadas, así como las entidades que no tienen atributos de versión, se pueden 
              bloquear de forma pesimista.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Para bloquear entidades de forma pesimista, establezca el modo de bloqueo en 
              <code>PESSIMISTIC_READ</code>, <code>PESSIMISTIC_WRITE</code> o 
              <code>PESSIMISTIC_FORCE_INCREMENT</code>.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Si no se puede obtener un bloqueo pesimista en las filas de la base de datos y el hecho de no 
              bloquear los datos da como resultado una reversión de la transacción, se lanza una 
              <code>PessimisticLockException</code>. Si no se puede obtener un bloqueo pesimista, pero la 
              falla de bloqueo no da como resultado una reversión de la transacción, se genera una 
              <code>LockTimeoutException</code>.
            </p>
          </div>
          <div class="paragraph">
            <p>
              Bloquear de manera pesimista una entidad versionada con <code>PESSIMISTIC_FORCE_INCREMENT</code> 
              da como resultado que el atributo de versión se incremente incluso si los datos de la entidad no 
              se modifican. Al bloquear de forma pesimista una entidad versionada, el proveedor de 
              persistencia realizará las comprobaciones de versión que se producen durante el bloqueo 
              optimista y, si la comprobación de versión falla, se lanzará una 
              <code>OptimisticLockException</code>. Un intento de bloquear una entidad no versionada con 
              <code>PESSIMISTIC_FORCE_INCREMENT</code> no es portable y puede generar una 
              <code>PersistenceException</code> si el proveedor de persistencia no admite bloqueos optimistas 
              para entidades no versionadas. Bloquear una entidad versionada con 
              <code>PESSIMISTIC_WRITE</code> da como resultado que el atributo de versión se incremente si la 
              transacción se confirmó correctamente.
            </p>
          </div>
          <div class="sect3" id="GKJLQ">
            <h4 id="pessimistic-locking-timeouts">Tiempos de Espera de los Bloqueos Pesimistas</h4>
            <div class="paragraph">
              <p>
                Utilice la propiedad <code>javax.persistence.lock.timeout</code> para especificar el tiempo en 
                milisegundos que el proveedor de persistencia debe esperar para obtener un bloqueo en las 
                tablas de la base de datos. Si el tiempo que lleva obtener un bloqueo excede el valor de esta 
                propiedad, se generará una <code>LockTimeoutException</code>, pero la transacción actual no se 
                marcará para reversión. Si establece esta propiedad en <code>0</code>, el proveedor de 
                persistencia debería generar una <code>LockTimeoutException</code> si no puede obtener un 
                bloqueo de inmediato.
              </p>
            </div>
            <table class="tableblock frame-all grid-all spread">
              <colgroup>
                <col style="width: 100%;">
              </colgroup>
              <tbody>
                <tr>
                  <td class="tableblock halign-left valign-top">
                    <div>
                      <div class="paragraph">
                        <p>Nota:</p>
                      </div>
                      <div class="paragraph">
                        <p>
                          Las aplicaciones portables no deben depender de la configuración de 
                          <code>javax.persistence.lock.timeout</code>, porque la estrategia de bloqueo y la 
                          base de datos subyacente pueden significar que no se puede usar el valor de tiempo 
                          de espera. El valor de <code>javax.persistence.lock.timeout</code> es una pista, no 
                          un contrato.
                        </p>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="paragraph">
              <p>
                Esta propiedad se puede configurar programáticamente pasándola a los métodos 
                <code>EntityManager</code> que permiten especificar modos de bloqueo, los métodos
                <code>Query.setLockMode</code> y <code>TypedQuery.setLockMode</code>, la anotación 
                <code>@NamedQuery</code> y el método <code>Persistence.createEntityManagerFactory</code>. 
                También se puede configurar como una propiedad en el descriptor de implementación 
                <code>persistence.xml</code>.
              </p>
            </div>
            <div class="paragraph">
              <p>
                Si <code>javax.persistence.lock.timeout</code> se establece en varios lugares, el valor se 
                determinará en el siguiente orden:
              </p>
            </div>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>
                    El argumento de uno de los métodos <code>EntityManager</code> o <code>Query</code>
                  </p>
                </li>
                <li>
                  <p>
                    La configuración en la anotación <code>@NamedQuery</code>
                  </p>
                </li>
                <li>
                  <p>
                    El argumento del método <code>Persistence.createEntityManagerFactory</code>
                  </p>
                </li>
                <li>
                  <p>
                    El valor en el descriptor de implementación <code>persistence.xml</code>
                  </p>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr />
    <table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>		
        <td align="left">
          <a href="persistence-locking001.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="persistence-entitygraphs.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <span id="copyright">
      <a href="img/cpyr.adoc">
        <img src="img/oracle.gif" height="10" alt="Logo de Oracle" />&nbsp;			
        <span>
          Copyright&nbsp;&copy;&nbsp;2017,&nbsp;Oracle&nbsp;y/o&nbsp;sus&nbsp;afiliados.&nbsp;Todos&nbsp;los&nbsp;
          derechos&nbsp;reservados.
        </span>
      </a>
    </span>
  </body>
</html>
