<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <title>Conexión Condicional de WebSockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
    <table id="doc-title" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top">
          <b>Plataforma Java, Edición Empresarial (Java EE) 8</b><br />
          <b>El Tutorial de Java EE</b>
        </td>
      </tr>
    </table>
    <hr />
    <table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>
        <td align="left">
          <a href="jsf-ws004.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="jsf-ws006.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <div class="sect1">
      <h2 id="conditionally-connecting-websockets">Conexión Condicional de WebSockets</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>
            Puede usar el atributo conectado opcional para controlar si se vuelve a conectar automáticamente 
            el WebSocket.
          </p>
        </div>
        <div class="paragraph">
          <p><code>&lt;f:websocket &#8230;&#8203; connected="#{bean.pushable}" /&gt;</code></p>
        </div>
        <div class="paragraph">
          <p>
            El atributo conectado tiene como valor predeterminado <code>true</code> y se interpreta como una 
            instrucción de JavaScript para abrir o cerrar la conexión push de WebSocket. Si el valor es una 
            expresión EL y se convierte en <code>false</code> durante una solicitud ajax, entonces la conexión 
            push se cerrará explícitamente durante el evento <code>oncomplete</code> de esa solicitud ajax.
          </p>
        </div>
        <div class="paragraph">
          <p>
            También puede configurarlo explícitamente en <code>false</code> y abrir manualmente la conexión 
            push en el lado del cliente invocando <code>jsf.push.open(clientId)</code>, pasando la ID de 
            cliente del componente.
          </p>
        </div>
        <div class="listingblock">
          <div class="content">
            <pre class="prettyprint highlight">
              <code class="language-oac_no_warn" data-lang="oac_no_warn">
&lt;h:commandButton ... onclick="jsf.push.open('foo')"&gt;
&lt;f:ajax ... /&gt;
&lt;/h:commandButton&gt;
&lt;f:websocket id="foo" channel="bar" scope="view" ...
connected="false" /&gt;
              </code>
            </pre>
          </div>
        </div>
        <div class="paragraph">
          <p>
            Si tiene la intención de enviar una sola vez y no espera recibir más mensajes, opcionalmente puede 
            cerrar explícitamente la conexión de inserción desde el lado del cliente invocando 
            <code>jsf.push.close(clientId)</code>, pasando el código de la identificación del componente 
            cliente. Por ejemplo, en la función de escucha de JavaScript <code>onmessage</code>, como se ve a 
            continuación:
          </p>
        </div>
        <div class="listingblock">
          <div class="content">
            <pre class="prettyprint highlight">
              <code class="language-oac_no_warn" data-lang="oac_no_warn">
function someWebsocketListener(message) {
// ... jsf.push.close('foo');
}
              </code>
            </pre>
          </div>
        </div>
        <div class="sect2">
          <h3 id="websocket-events-server">Eventos de WebSocket: Servidor</h3>
          <div class="paragraph">
            <p>
              Cuando una sesión o un socket con ámbito de vista se cierra automáticamente con el código de 
              motivo de cierre <code>1000</code> por parte del servidor (y, por lo tanto, el cliente no lo 
              cierra manualmente a través de <code>jsf.push.close(clientId)</code>), significa que la sesión o 
              vista ha caducado.
            </p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre class="prettyprint highlight">
                <code class="language-oac_no_warn" data-lang="oac_no_warn">
@ApplicationScoped
public class WebsocketObserver {
public void onOpen(@Observes @Opened WebsocketEvent event) { String channel = event.getChannel();
// Devuelve &lt;f:websocket channel&gt;. Long userId = event.getUser();
// Devuelve &lt;f:websocket user&gt;, si hay alguno.
// ...
}
public void onClose(@Observes @Closed WebsocketEvent event) { String channel = event.getChannel();
// Devuelve &lt;f:websocket channel&gt;. Long userId = event.getUser();
// Devuelve &lt;f:websocket user&gt;, si hay alguno. CloseCode code = event.getCloseCode();
// Devuelve el código de la razón del cierre.
// ...
}
                </code>
              </pre>
            </div>
          </div>
        </div>
        <div class="sect2">
          <h3 id="websocket-events-clients">Eventos de WebSocket: Clientes</h3>
          <div class="paragraph">
            <p>
              Puede usar la función de escucha de JavaScript opcional <code>onopen</code> para escuchar la 
              apertura de un WebSocket en el lado del cliente. Esta función se invoca en el primer intento de 
              conexión, independientemente de si tendrá éxito. No se invocará cuando WebSocket vuelva a 
              conectar automáticamente una conexión interrumpida después de la primera conexión exitosa.
            </p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre class="prettyprint highlight">
                <code class="language-oac_no_warn" data-lang="oac_no_warn">
&lt;f:websocket ... onopen="websocketOpenListener" /&gt;
function websocketOpenListener(channel) {
// ...
}
                </code>
              </pre>
            </div>
          </div>
          <div class="paragraph">
            <p>
              La función de escucha de JavaScript <code>onopen</code> se invoca con un argumento: 
              <code>channel</code> (el nombre del canal, particularmente útil si tiene un escucha global).
            </p>
          </div>
          <div class="paragraph">
            <p>
              Puede usar la función de escucha de JavaScript opcional <code>onclose</code> para escuchar un 
              cierre normal o anormal de un WebSocket. Esta función se invoca cuando falla el primer intento 
              de conexión, o el servidor ha devuelto el código de motivo de cierre <code>1000</code> 
              (cierre normal) o <code>1008</code> (política violada), o se han superado los intentos de 
              reconexión máxima. No se invocará si WebSocket realiza un intento de reconexión automática en 
              una conexión interrumpida después de la primera conexión exitosa.
            </p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre class="prettyprint highlight">
                <code class="language-oac_no_warn" data-lang="oac_no_warn">
&lt;f:websocket ... onclose="websocketCloseListener" /&gt;
function websocketCloseListener(code, channel, event) { 
  if (code == -1) {
    // Websockets no soportados por el cliente.
  } else if (code == 1000) {
    // Cierre normal (como resultado de sesión o vista expirada).
  } else {
  // Razón de cierre anormal (como resultado de un error).
  }
}
                </code>
              </pre>
            </div>
          </div>
          <div class="paragraph">
            <p>La función de escucha JavaScript <code>onclose</code> se invoca con tres argumentos:</p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p>
                  <code>code</code>: El código de motivo de cierre como un número entero. Si es 
                  <code>-1</code>, el WebSocket no es compatible con el cliente. Si es <code>1000</code>, 
                  normalmente estaba cerrado. De lo contrario, si no es <code>1000</code>, entonces podría 
                  haber un error.
                </p>
              </li>
              <li>
                <p><code>channel</code>: El nombre del canal</p>
              </li>
              <li>
                <p><code>event</code>: La instancia <code>CloseEvent</code></p>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <hr />
    <table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>		
        <td align="left">
          <a href="jsf-ws004.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="jsf-ws006.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <span id="copyright">
      <a href="img/cpyr.adoc">
        <img src="img/oracle.gif" height="10" alt="Logo de Oracle" />&nbsp;			
        <span>
          Copyright&nbsp;&copy;&nbsp;2017,&nbsp;Oracle&nbsp;y/o&nbsp;sus&nbsp;afiliados.&nbsp;Todos&nbsp;los&nbsp;
          derechos&nbsp;reservados.
        </span>
      </a>
    </span>
  </body>
</html>
