<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <title>Finalizando un Servlet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
    <table id="doc-title" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top">
          <b>Plataforma Java, Edición Empresarial (Java EE) 8</b><br />
          <b>El Tutorial de Java EE</b>
        </td>
      </tr>
    </table>
    <hr />
    <table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>
        <td align="left">
          <a href="servlets009.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="servlets011.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <div class="sect1" id="BNAGS">
      <h2 id="finalizing-a-servlet">Finalizando un Servlet</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>
            El contenedor web puede determinar que un servlet debe retirarse del servicio (por ejemplo, cuando 
            un contenedor desea recuperar recursos de memoria o cuando se está cerrando). En tal caso, el 
            contenedor llama al método <code>destroy</code> de la interfaz <code>Servlet</code>. En este 
            método, libera cualquier recurso que esté usando el servlet y guarda cualquier estado persistente. 
            El método <code>destroy</code> libera el objeto de base de datos creado en el método 
            <code>init</code>.
          </p>
        </div>
        <div class="paragraph">
          <p>
            Todos los métodos de servicio de un servlet deben estar completos cuando se elimina un servlet. El 
            servidor intenta garantizar esto llamando al método <code>destroy</code> solo después de que todas 
            las solicitudes de servicio hayan regresado o después de un período de gracia específico del 
            servidor, lo que ocurra primero. Si su servlet tiene operaciones que pueden ejecutarse por más 
            tiempo que el período de gracia del servidor, las operaciones aún podrían estar ejecutándose 
            cuando se llame a <code>destroy</code>. Debe asegurarse de que todos los subprocesos que todavía 
            manejan las solicitudes de los clientes estén completos.
          </p>
        </div>
        <div class="paragraph">
          <p>El resto de esta sección explica cómo hacer lo siguiente.</p>
        </div>
        <div class="ulist">
          <ul>
            <li>
              <p>
                Realizar un seguimiento de cuántos subprocesos están ejecutando actualmente el método 
                <code>service</code>.
              </p>
            </li>
            <li>
              <p>
                Proporcionar un cierre limpio haciendo que el método <code>destroy</code> notifique el cierre 
                a los subprocesos de ejecución prolongada y espere a que se completen.
              </p>
            </li>
            <li>
              <p>
                Hacer que los métodos de ejecución prolongada realicen un sondeo periódico para verificar el 
                apagado y, si es necesario, dejar de funcionar, limpiar y regresar.
              </p>
            </li>
          </ul>
        </div>
        <div class="sect2" id="BNAGT">
          <h3 id="tracking-service-requests">Seguimiento de Solicitudes de Servicio</h3>
          <div class="paragraph">
            <p>Para realizar un seguimiento de las solicitudes de servicio:</p>
          </div>
          <div class="olist arabic">
            <ol class="arabic">
              <li>
                <p>
                  Incluir un campo en su clase de servlet que cuente la cantidad de métodos de servicio que se 
                  están ejecutando.
                </p>
                <div class="paragraph">
                  <p>
                    El campo debe tener métodos de acceso sincronizados para incrementar, disminuir y devolver 
                    su valor:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
public class ShutdownExample extends HttpServlet {
    private int serviceCounter = 0;
    ...
    // Métodos de acceso para serviceCounter
    protected synchronized void enteringServiceMethod() {
        serviceCounter++;
    }
    protected synchronized void leavingServiceMethod() {
        serviceCounter--;
    }
    protected synchronized int numServices() {
        return serviceCounter;
    }
}
                      </code>
                    </pre>
                  </div>
                </div>
                <div class="paragraph">
                  <p>
                    El método <code>service</code> debe incrementar el contador de servicio cada vez que se 
                    ingresa en el método y debe disminuir el contador cada vez que el método regresa. Esta es 
                    una de las pocas veces que su subclase <code>HttpServlet</code> debe anular el método 
                    <code>service</code>. El nuevo método debería llamar a <code>super.service</code> para 
                    conservar la funcionalidad del método <code>service</code> original:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
protected void service(HttpServletRequest req,
                       HttpServletResponse resp)
                       throws ServletException,IOException {
    enteringServiceMethod();
    try {
        super.service(req, resp);
    } finally {
        leavingServiceMethod();
    }
}
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="sect2" id="BNAGU">
          <h3 id="notifying-methods-to-shut-down">Métodos de Notificación para Apagar</h3>
          <div class="paragraph">
            <p>
              Para garantizar un apagado limpio, su método <code>destroy</code> no debe liberar ningún recurso 
              compartido hasta que se hayan completado todas las solicitudes de servicio:
            </p>
          </div>
          <div class="olist arabic">
            <ol class="arabic">
              <li>
                <p>Consultar el contador de servicio.</p>
              </li>
              <li>
                <p>Notificar a los métodos de ejecución prolongada que es hora de cerrar.</p>
                <div class="paragraph">
                  <p>
                    Para esta notificación, se requiere otro campo. El campo debe tener los métodos de acceso 
                    habituales:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
public class ShutdownExample extends HttpServlet {
    private boolean shuttingDown;
    ...
    //Métodos de acceso para shuttingDown
    protected synchronized void setShuttingDown(boolean flag) {
        shuttingDown = flag;
    }
    protected synchronized boolean isShuttingDown() {
        return shuttingDown;
    }
}
                      </code>
                    </pre>
                  </div>
                </div>
                <div class="paragraph">
                  <p>
                    Aquí hay un ejemplo del método <code>destroy</code> usando estos campos para proporcionar 
                    un apagado limpio:
                  </p>
                </div>
                <div class="listingblock">
                  <div class="content">
                    <pre class="prettyprint highlight">
                      <code class="language-oac_no_warn" data-lang="oac_no_warn">
public void destroy() {
    /* Comprobar si todavía hay métodos de servicio /*
    /* corriendo, y si los hay, decirles que se detengan. */
    if (numServices()&gt; 0) {
        setShuttingDown(true);
    }
    /* Esperar a que se detengan los métodos de servicio. */
    while (numServices()&gt; 0) {
        try {
            Thread.sleep(interval);
        } catch (InterruptedException e) {
        }
    }
}
                      </code>
                    </pre>
                  </div>
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="sect2" id="BNAGV">
          <h3 id="creating-polite-long-running-methods">Creando Métodos Educados de Larga Duración</h3>
          <div class="paragraph">
            <p>
              El paso final para proporcionar un apagado limpio es hacer que los métodos de ejecución 
              prolongada se comporten de manera cortés. Los métodos que pueden ejecutarse durante mucho tiempo 
              deben verificar el valor del campo que les notifica las paradas y deben interrumpir su trabajo, 
              si es necesario:
            </p>
          </div>
          <div class="listingblock">
            <div class="content">
              <pre class="prettyprint highlight">
                <code class="language-oac_no_warn" data-lang="oac_no_warn">
public void doPost(...) {
    ...
    for(i = 0; ((i &lt; lotsOfStuffToDo) &amp;&amp;
         !isShuttingDown()); i++) {
        try {
            partOfLongRunningOperation(i);
        } catch (InterruptedException e) {
            ...
        }
    }
}
                </code>
              </pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr />
    <table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>		
        <td align="left">
          <a href="servlets009.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="servlets011.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <span id="copyright">
      <a href="img/cpyr.adoc">
        <img src="img/oracle.gif" height="10" alt="Logo de Oracle" />&nbsp;			
        <span>
          Copyright&nbsp;&copy;&nbsp;2017,&nbsp;Oracle&nbsp;y/o&nbsp;sus&nbsp;afiliados.&nbsp;Todos&nbsp;los&nbsp;
          derechos&nbsp;reservados.
        </span>
      </a>
    </span>
  </body>
</html>
