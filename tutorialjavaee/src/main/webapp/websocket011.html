<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <title>La Aplicación de Ejemplo dukeetf2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
    <table id="doc-title" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top">
          <b>Plataforma Java, Edición Empresarial (Java EE) 8</b><br />
          <b>El Tutorial de Java EE</b>
        </td>
      </tr>
    </table>
    <hr />
    <table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>
        <td align="left">
          <a href="websocket010.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="websocket012.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <div class="sect1" id="BABGCEHE">
      <h2 id="the-dukeetf2-example-application">La Aplicación de Ejemplo dukeetf2</h2>
      <div class="sectionbody">
        <div class="paragraph">
          <p>
            La aplicación de ejemplo <code>dukeetf2</code>, que se encuentra en el directorio 
            tut-install`/examples/web/websocket/dukeetf2/`, demuestra cómo usar un extremo de WebSocket para 
            proporcionar actualizaciones de datos a los clientes web. El ejemplo se asemeja a un servicio que 
            proporciona actualizaciones periódicas sobre el precio y el volumen de negociación de un fondo 
            negociado electrónicamente (ETF).
          </p>
        </div>
        <div class="paragraph">
          <p>Aquí se tratan los siguientes temas:</p>
        </div>
        <div class="ulist">
          <ul>
            <li>
              <p><a href="#CIHJHJCD">Arquitectura de la Aplicación de Ejemplo dukeetf2</a></p>
            </li>
            <li>
              <p><a href="#CIHHBAIC">Ejecutando la Aplicación de Ejemplo dukeetf2</a></p>
            </li>
          </ul>
        </div>
        <div class="sect2" id="CIHJHJCD">
          <h3 id="architecture-of-the-dukeetf2-sample-application">
            Arquitectura de la Aplicación de Ejemplo dukeetf2
          </h3>
          <div class="paragraph">
            <p>
              La aplicación de ejemplo <code>dukeetf2</code> consta de un punto final WebSocket, un bean 
              empresarial y una página HTML.
            </p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p>
                  El punto final acepta conexiones de clientes y les envía actualizaciones cuando hay nuevos 
                  datos disponibles para el precio y el volumen de negociación.
                </p>
              </li>
              <li>
                <p>El Enterprise bean actualiza la información de precio y volumen una vez por segundo.</p>
              </li>
              <li>
                <p>
                  La página HTML utiliza código JavaScript para conectarse al extremo de WebSocket, analizar 
                  los mensajes entrantes y actualizar la información de precio y volumen sin recargar la 
                  página.
                </p>
              </li>
            </ul>
          </div>
          <div class="sect3" id="sthref116">
            <h4 id="the-endpoint">El Endpoint</h4>
            <div class="paragraph">
              <p>
                El punto final de WebSocket se implementa en la clase <code>ETFEndpoint</code>, que almacena 
                todas las sesiones conectadas en una cola y proporciona un método al que llama el bean 
                empresarial cuando hay nueva información disponible para enviar:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@ServerEndpoint("/dukeetf")
public class ETFEndpoint {
   private static final Logger logger = Logger.getLogger("ETFEndpoint");
   /* Cola para todas las sesiones abiertas de WebSocket */
   static Queue&lt;Session&gt; queue = new ConcurrentLinkedQueue&lt;&gt;();
   /* PriceVolumeBean llama a este método para enviar actualizaciones */
   public static void send(double price, int volume) {
      String msg = String.format("%.2f / %d", price, volume);
      try {
         /* Envia actualizaciones a todas las sesiones abiertas de WebSocket */
         for (Session session : queue) {
            session.getBasicRemote().sendText(msg);
            logger.log(Level.INFO, "Sent: {0}", msg);
         }
      } catch (IOException e) {
         logger.log(Level.INFO, e.toString());
      }
    }
    ...
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                Los métodos de ciclo de vida del punto final agregan y eliminan sesiones hacia y desde la 
                cola:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@ServerEndpoint("/dukeetf")
public class ETFEndpoint {
   ...
   @OnOpen
   public void openConnection(Session session) {
      /* Registrar esta conexión en la cola */
      queue.add(session);
      logger.log(Level.INFO, "Conexión abierta.");
   }
   @OnClose
   public void closedConnection(Session session) {
      /* Eliminar esta conexión de la cola */
      queue.remove(session);
      logger.log(Level.INFO, "Conexión cerrada.");
   }
   @OnError
   public void error(Session session, Throwable t) {
      /* Eliminar esta conexión de la cola */
      queue.remove(session);
      logger.log(Level.INFO, t.toString());
      logger.log(Level.INFO, "Error de conexión.");
   }
}
                  </code>
                </pre>
              </div>
            </div>
          </div>
          <div class="sect3" id="sthref117">
            <h4 id="the-enterprise-bean">El Enterprise Bean</h4>
            <div class="paragraph">
              <p>
                El bean empresarial utiliza el servicio de temporizador para generar nueva información de 
                precio y volumen cada segundo:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
@Startup
@Singleton
public class PriceVolumeBean {
   /* Usa el servicio de temporizador del contenedor*/
   @Resource TimerService tservice;
   private Random random;
   private volatile double price = 100.0;
   private volatile int volume = 300000;
   private static final Logger logger = Logger.getLogger("PriceVolumeBean");
   @PostConstruct
   public void init() {
       /* Inicializa el EJB y crear un temporizador */
       logger.log(Level.INFO, "Inicializando EJB.");
       random = new Random();
       tservice.createIntervalTimer(1000, 1000, new TimerConfig());
   }
   @Timeout
   public void timeout() {
       /* Ajustar el precio y el volumen y enviar actualizaciones */
       price += 1.0*(random.nextInt(100)-50)/100.0;
       volume += random.nextInt(5000) - 2500;
       ETFEndpoint.send(price, volume);
   }
}
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                El bean empresarial llama al método <code>send</code> de la clase <code>ETFEndpoint</code> en 
                el método de tiempo de espera. Consulte 
                <a href="ejb-basicexamples005.html#BNBOY">Uso del servicio de temporizador</a> en 
                <a href="ejb-basicexamples.html#GIJRB">
                  Capítulo 37, "Ejecutando los ejemplos de Enterprise Bean"</a> para obtener más información 
                sobre el servicio de temporizador.
              </p>
            </div>
          </div>
          <div class="sect3" id="CIHHIEFH">
            <h4 id="the-html-page">La Página HTML</h4>
            <div class="paragraph">
              <p>
                La página HTML consta de una tabla y algo de código JavaScript. La tabla contiene dos campos a 
                los que se hace referencia desde el código JavaScript:
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;...&lt;/head&gt;
&lt;body&gt;
  ...
  &lt;table&gt;
    ...
    &lt;td id="price"&gt;--.--&lt;/td&gt;
    ...
    &lt;td id="volume"&gt;--&lt;/td&gt;
    ...
  &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                El código JavaScript utiliza la IPA de WebSocket para conectarse al extremo del servidor y 
                designar un método de devolución de llamada para los mensajes entrantes. El método de 
                devolución de llamada actualiza la página con la nueva información.
              </p>
            </div>
            <div class="listingblock">
              <div class="content">
                <pre class="prettyprint highlight">
                  <code class="language-oac_no_warn" data-lang="oac_no_warn">
var wsocket;
function connect() {
   wsocket = new WebSocket("ws://localhost:8080/dukeetf2/dukeetf");
   wsocket.onmessage = onMessage;
}
function onMessage(evt) {
   var arraypv = evt.data.split("/");
   document.getElementById("price").innerHTML = arraypv[0];
   document.getElementById("volume").innerHTML = arraypv[1];
}
window.addEventListener("load", connect, false);
                  </code>
                </pre>
              </div>
            </div>
            <div class="paragraph">
              <p>
                La IPA de WebSocket es compatible con la mayoría de los navegadores modernos y se usa 
                ampliamente en el desarrollo de clientes web HTML5.
              </p>
            </div>
          </div>
        </div>
        <div class="sect2" id="CIHHBAIC">
          <h3 id="running-the-dukeetf2-example-application">Ejecutando la Aplicación de Ejemplo dukeetf2</h3>
          <div class="paragraph">
            <p>
              Esta sección describe cómo ejecutar la aplicación de ejemplo <code>dukeetf2</code> utilizando el 
              EID de NetBeans y desde la línea de comandos.
            </p>
          </div>
          <div class="paragraph">
            <p>Aquí se tratan los siguientes temas:</p>
          </div>
          <div class="ulist">
            <ul>
              <li>
                <p>
                  <a href="#CIHEBIAH">
                    Para Ejecutar la Aplicación de Ejemplo dukeetf2 Usando el EID NetBeans
                  </a>
                </p>
              </li>
              <li>
                <p><a href="#CIHDJCGJ">Para Ejecutar la Aplicación de Ejemplo dukeetf2 Usando Maven</a></p>
              </li>
            </ul>
          </div>
          <div class="sect3" id="CIHEBIAH">
            <h4 id="to-run-the-dukeetf2-example-application-using-netbeans-ide">
              Para Ejecutar la Aplicación de Ejemplo dukeetf2 Usando el EID NetBeans
            </h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>
                    Asegúrese de que GlassFish Server se haya iniciado (consulte 
                    <a href="usingexamples002.html#BNADI">Arrancando y Parando el Servidor GlassFish</a>).
                  </p>
                </li>
                <li>
                  <p>En el menú Archivo, elija Abrir Proyecto.</p>
                </li>
                <li>
                  <p>En el cuadro de diálogo Abrir Proyecto, vaya a:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
tut-install/examples/web/websocket
                        </code>
                      </pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Seleccione la carpeta <code>dukeetf2</code>.</p>
                </li>
                <li>
                  <p>Haga clic en Abrir Proyecto.</p>
                </li>
                <li>
                  <p>
                    En la pestaña Proyectos, haga clic con el botón derecho en el proyecto 
                    <code>dukeetf2</code> y seleccione Ejecutar.
                  </p>
                  <div class="paragraph">
                    <p>
                      Este comando compila y empaqueta la aplicación en un archivo WAR 
                      (<code>dukeetf2.war</code>) ubicado en el directorio <code>target/</code>, lo implementa 
                      en el servidor y abre una ventana del navegador web con la siguiente URL:
                    </p>
                  </div>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
http://localhost:8080/dukeetf2/
                        </code>
                      </pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      Abra la misma URL en una pestaña o ventana diferente del navegador web para ver cómo 
                      ambas páginas obtienen actualizaciones de precio y volumen simultáneamente.
                    </p>
                  </div>
                </li>
              </ol>
            </div>
          </div>
          <div class="sect3" id="CIHDJCGJ">
            <h4 id="to-run-the-dukeetf2-example-application-using-maven">
              Para Ejecutar la Aplicación de Ejemplo dukeetf2 Usando Maven
            </h4>
            <div class="olist arabic">
              <ol class="arabic">
                <li>
                  <p>
                    Asegúrese de que GlassFish Server se haya iniciado (consulte 
                    <a href="usingexamples002.html#BNADI">Arrancando y Parando el Servidor GlassFish</a>).
                  </p>
                </li>
                <li>
                  <p>En una ventana de terminal, vaya a:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
tut-install/examples/web/websocket/dukeetf2/
                        </code>
                      </pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Ingrese el siguiente comando para implementar la aplicación:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
mvn install
                        </code></pre>
                    </div>
                  </div>
                </li>
                <li>
                  <p>Abra una ventana del navegador web e ingrese la siguiente URL:</p>
                  <div class="listingblock">
                    <div class="content">
                      <pre class="prettyprint highlight">
                        <code class="language-oac_no_warn" data-lang="oac_no_warn">
http://localhost:8080/dukeetf2/
                        </code>
                      </pre>
                    </div>
                  </div>
                  <div class="paragraph">
                    <p>
                      Abra la misma URL en una pestaña o ventana diferente del navegador web para ver cómo 
                      ambas páginas obtienen actualizaciones de precio y volumen simultáneamente.
                    </p>
                  </div>
                </li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr />
    <table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
      <colgroup>
        <col width="12%"/>
        <col width="12%"/>
        <col width="*"/>
      </colgroup>
      <tr>		
        <td align="left">
          <a href="websocket010.html">
            <span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Anterior</span>
          </a>
        </td>
        <td align="left">
          <a href="websocket012.html">
            <span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Siguiente</span>
          </a>
        </td>
        <td align="right">
          <a href="toc.html">
            <span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
            <span style="position:relative;top:-2px;">Contenidos</span>
          </a>
        </td>
      </tr>
    </table>
    <span id="copyright">
      <a href="img/cpyr.adoc">
        <img src="img/oracle.gif" height="10" alt="Logo de Oracle" />&nbsp;			
        <span>
          Copyright&nbsp;&copy;&nbsp;2017,&nbsp;Oracle&nbsp;y/o&nbsp;sus&nbsp;afiliados.&nbsp;Todos&nbsp;los&nbsp;
          derechos&nbsp;reservados.
        </span>
      </a>
    </span>
  </body>
</html>
