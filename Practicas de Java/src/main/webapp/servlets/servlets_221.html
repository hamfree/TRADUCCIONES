<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Prácticas y técnicas de programación en Java.">
    <meta name="keywords" content="java, programación java, Prácticas de Java, idioma java, estilo java, patrones de diseño java, 
          convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prácticas de Java-&gt;Encapsule las peticiones de subida de fichero</title>
    <link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido" style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search" class="search-form" style="float: right;">
        <input name="q" size="15" maxlength="255" placeholder="" type="text" />
        <input name="btnG" value="Search" type="submit" /> 
        <input name="sitesearch" value="www.javapractices.com" type="hidden" />
      </form>
    </nav>
    <div class="page-title">Encapsule las peticiones de subida de fichero</div>
    <br /> 
    El soporte para la subida de archivos fue agregado relativamente tarde a la Especificación de Servlet, empezando con la versión 
    3.0. Las versiones anteriores de la especificación tenían poca compatibilidad con la carga de archivos. Lo siguiente aplica a 
    dichas versiones anteriores.
    <p>
      Si un formulario contiene uno o más controles de 
      <a href="https://www.w3.org/TR/html5/forms.html#file-upload-state-(type=file)">file upload</a>, el formato de la petición HTTP 
      subyacente cambia dramáticamente. A menos que se tomen pasos especiales, es probable que 
      <code>
        request.<a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.String-">getParameter</a>(String)
      </code>
      devuelva <code>null</code> para <em>todos</em> los parámetros (tanto parámetros regulares como parámetros de carga de 
      archivos).
    </p>
    <p>
      Recordatorio - si un formulario incluye un control de carga de archivo, entonces debe tener:
    </p>
    <ul>
      <li><code>method='POST'</code></li>
      <li><code>enctype='multipart/form-data'</code></li>
    </ul>
    <p>
      Una técnica para manejar las peticiones de carga de archivos usa un <em>encapsulador</em> para la petición subyacente, tal que 
      <code>request.getParameter(String)</code> y los métodos relacionados puedan utilizarse de la forma habitual.
    </p>
    <p>
      <b>Ejemplo</b>
    </p>
    <p>
      El siguiente encapsulador usa la herramienta de Apache Commons <a href="http://commons.apache.org/fileupload/">FileUpload</a> 
      para analizar la petición tanto de parámetros regulares como parámetros de carga de archivos. Una clase de acción puede usar 
      esta clase como lo haría con cualquier solicitud, con una excepción: para acceder a los métodos relacionados específicamente 
      con los archivos, se necesita una conversión.<br />
    </p>
    <pre>
<span class="keyword">import</span> java.util.*;
<span class="keyword">import</span> java.io.*;
<span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;
<span class="keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;
<span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;
<span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;
<span class="keyword">import</span> org.apache.commons.fileupload.FileItem;

<span class="comment">/**
* Envoltura para una petición de carga de archivos (antes de Servlet 3.0).
* 
* &lt;P&gt;Esta clase usa la 
* &lt;a href='http://commons.apache.org/fileupload/'&gt;herramienta de Carga de Archivos&lt;/a&gt;.
* de Apache Commons. La generosa Licencia de Apache License probablemente le permitirá usarla 
* en sus aplicaciones también. 
*/</span>
<span class="keyword">public</span> <span class="keyword">class</span> FileUploadWrapper <span
            class="keyword">extends</span> HttpServletRequestWrapper {
  
  <span class="comment">/** Constructor.  */</span>
  <span class="keyword">public</span> FileUploadWrapper(HttpServletRequest aRequest) <span
            class="keyword">throws</span> IOException {
    <span class="keyword">super</span>(aRequest);
    ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload( <span
            class="keyword">new</span> DiskFileItemFactory());
    <span class="keyword">try</span> {
      List&lt;FileItem&gt; fileItems = upload.parseRequest(aRequest);
      convertToMaps(fileItems);
    }
    <span class="keyword">catch</span>(FileUploadException ex){
      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span
            class="literal">"No puedo analizar la petición subyacente: "</span> + ex.toString());
    }
  }
  
  <span class="comment">/**
  * Devuelve todos los nombres de parámetros de la petición, tanto controles regulares como controles de carga de 
  * archivos.
  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> Enumeration&lt;String&gt; getParameterNames() {
    Set&lt;String&gt; allNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();
    allNames.addAll(fRegularParams.keySet());
    allNames.addAll(fFileParams.keySet());
    <span class="keyword">return</span> Collections.enumeration(allNames);
  }
  
  <span class="comment">/**
  * Devuelve el valor del parámetro. Aplica solo a parámetros regulares, no a parámetros de 
  * de carga de archivos. 
  * 
  * &lt;P&gt;Si el parámetro no está presente en la petición subyacente, 
  * entonces se devuelve &lt;tt&gt;null&lt;/tt&gt;.
  * &lt;P&gt;Si el parámetro está presente, pero no tiene valor asociado, 
  * entonces se devuelve una cadena vacía.
  * &lt;P&gt;Si el parámetro es multivalor, devuelve el primer valor que aparece en la 
  * petición.  
  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> String getParameter(String aName) {
    String result = <span class="keyword">null</span>;
    List&lt;String&gt; values = fRegularParams.get(aName);
    <span class="keyword">if</span>(values == <span class="keyword">null</span>){
      <span class="comment">//puede probar la envoltura, para ver si tiene un valor
</span>    }
    <span class="keyword">else</span> <span class="keyword">if</span> (values.isEmpty()) {
      <span class="comment">//nombre de parámetro conocido, pero no hay valores presentes
</span>      result = <span class="literal">""</span>;
    }
    <span class="keyword">else</span> {
      <span class="comment">//devuelve el primer valor en la lista
</span>      result = values.get(FIRST_VALUE);
    }
    <span class="keyword">return</span> result;
  }
  
  <span class="comment">/**
  * Devuelve los valores del parámetro. Se aplica solo a parámetros regulares, 
  * no a parámetros de carga de archivos.
  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> String[] getParameterValues(String aName) {
    String[] result = <span class="keyword">null</span>;
    List&lt;String&gt; values = fRegularParams.get(aName);
    <span class="keyword">if</span>(values != <span class="keyword">null</span>) {
      result = values.toArray(<span class="keyword">new</span> String[values.size()]);
    }
    <span class="keyword">return</span> result;
  }
  
  <span class="comment">/**
  * Devuelve una {@code Map&lt;String, List&lt;String&gt;&gt;} de todos los parámetros regulares.
  * No devuelve ningún parámetro de carga de archivos en absoluto. 
  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; getParameterMap() {
    <span class="keyword">return</span> Collections.unmodifiableMap(fRegularParams);
  }
  
  <span class="comment">/**
  * Devuelve una {@code List&lt;FileItem&gt;}, en el mismo orden en que aparece 
  *  en la petición subyacente.
  */</span>
  <span class="keyword">public</span> List&lt;FileItem&gt; getFileItems(){
    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;FileItem&gt;(fFileParams.values());
  }
  
  <span class="comment">/**
  * Devuelve el {@link FileItem} del nombre dado.
  * &lt;P&gt;Si el nombre es desconocido, entonces devuelve &lt;tt&gt;null&lt;/tt&gt;.
  */</span>
  <span class="keyword">public</span> FileItem getFileItem(String aFieldName){
    <span class="keyword">return</span> fFileParams.get(aFieldName);
  }
  
  
  <span class="comment">// PRIVADO
</span>  
  <span class="comment">/** Almacena solo parámetros regulares. Puede ser multivalor (de ahí la List).  */</span>
  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; fRegularParams = <span
            class="keyword">new</span> LinkedHashMap&lt;&gt;();

  <span class="comment">/** Almacena solo parámetros de archivo. */</span>
  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FileItem&gt; fFileParams = <span
            class="keyword">new</span> LinkedHashMap&lt;&gt;();
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">int</span> FIRST_VALUE = <span
            class="literal">0</span>;
  
  <span class="keyword">private</span> <span class="keyword">void</span> convertToMaps(List&lt;FileItem&gt; aFileItems){
    <span class="keyword">for</span>(FileItem item: aFileItems) {
      <span class="keyword">if</span> ( isFileUploadField(item) ) {
        fFileParams.put(item.getFieldName(), item);
      }
      <span class="keyword">else</span> {
        <span class="keyword">if</span>( alreadyHasValue(item) ){
          addMultivaluedItem(item);
        }
        <span class="keyword">else</span> {
          addSingleValueItem(item);
        }
      }
    }
  }
  
  <span class="keyword">private</span> <span class="keyword">boolean</span> isFileUploadField(FileItem aFileItem){
    <span class="keyword">return</span> ! aFileItem.isFormField();
  }
  
  <span class="keyword">private</span> <span class="keyword">boolean</span> alreadyHasValue(FileItem aItem){
    <span class="keyword">return</span> fRegularParams.get(aItem.getFieldName()) != <span
            class="keyword">null</span>;
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> addSingleValueItem(FileItem aItem){
    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();
    list.add(aItem.getString());
    fRegularParams.put(aItem.getFieldName(), list);
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> addMultivaluedItem(FileItem aItem){
    List&lt;String&gt; values = fRegularParams.get(aItem.getFieldName());
    values.add(aItem.getString());
  }
} 
    </pre>
    El contenedor es a su vez utilizado por un <code>Filter</code>:<br />
    <pre>
<span class="keyword">import</span> java.io.*;
<span class="keyword">import</span> javax.servlet.Filter;
<span class="keyword">import</span> javax.servlet.FilterChain;
<span class="keyword">import</span> javax.servlet.FilterConfig;
<span class="keyword">import</span> javax.servlet.ServletException;
<span class="keyword">import</span> javax.servlet.ServletRequest;
<span class="keyword">import</span> javax.servlet.ServletResponse;
<span class="keyword">import</span> javax.servlet.http.HttpServletRequest;

<span class="comment">/**
* Filtro que encapsula una petición de carga de archivo subyacente (antes de Servlet 3.0). 
* 
* &lt;P&gt;Este filtro debe ser configurado solo para aquellas operaciones que usen una 
* petición de carga de archivos.
*/</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> FileUploadFilter <span
            class="keyword">implements</span> Filter {

  <span class="keyword">public</span> <span class="keyword">void</span> init(FilterConfig aConfig) <span
            class="keyword">throws</span> ServletException {
    <span class="comment">//no hace nada
</span>  }
  
  <span class="keyword">public</span> <span class="keyword">void</span> destroy() {
    <span class="comment">//no hace nada
</span>  }
  
  <span class="keyword">public</span> <span class="keyword">void</span> doFilter(
   ServletRequest aRequest, ServletResponse aResponse, FilterChain aChain
  ) <span class="keyword">throws</span> IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest) aRequest;
    <span class="keyword">if</span> ( isFileUploadRequest(request) ) {
      FileUploadWrapper wrapper = <span class="keyword">new</span> FileUploadWrapper(request);
      aChain.doFilter(wrapper, aResponse);
    }
    <span class="keyword">else</span> {
      aChain.doFilter(aRequest, aResponse);
    }
  }
  
  <span class="keyword">private</span> <span class="keyword">boolean</span> isFileUploadRequest(HttpServletRequest aRequest){
    <span class="keyword">return</span>     
      aRequest.getMethod().equalsIgnoreCase(<span class="literal">"POST"</span>) &amp;&amp; 
      aRequest.getContentType().startsWith(<span class="literal">"multipart/form-data"</span>)
    ;
  }
}
 
    </pre>
    El <code>Filter</code> se configura en <code>web.xml</code> para manejar URLs específicas:
    <p></p>
    <pre>
&lt;web-app&gt;
  &lt;filter&gt;
   &lt;filter-name&gt;FileUpload&lt;/filter-name&gt;
   &lt;display-name&gt;File Upload&lt;/display-name&gt;
   &lt;description&gt;
     Aplicado a las peticiones de carga de archivos.
     Encapsula la petición, permitiéndose que se use como una petición regular, 
     'como si' fuera analizada por la IPA de Servlet.
   &lt;/description&gt;
   &lt;filter-class&gt;com.blah.FileUploadFilter&lt;/filter-class&gt;
  &lt;/filter&gt;

  &lt;filter-mapping&gt;
   &lt;filter-name&gt;FileUpload&lt;/filter-name&gt;
   &lt;url-pattern&gt;/someurl/*&lt;/url-pattern&gt;
  &lt;/filter-mapping&gt;

  &lt;!-- Se requiere la herramienta Apache FileUpload. --&gt;
  &lt;listener&gt;
    &lt;listener-class&gt;
     org.apache.commons.fileupload.servlet.FileCleanerCleanup
    &lt;/listener-class&gt;
  &lt;/listener&gt; 
&lt;/web-app&gt;
    </pre>
    <p>
      Hay una variación con respecto al método 
      <code>
        request.<a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getParameter-java.lang.String-">getParameter</a>(String)
      </code> que puede ser importante aquí. Este método toma un argumento de ruta, y esa ruta puede contener parámetros de consulta 
      <em>no presentes en la petición original</em>. Por lo tanto, el contenedor anterior no 'verá' tales parámetros de consulta 
      a menos que se tomen medidas especiales. Por ejemplo, <code>getParameter(String)</code> podría ser modificada siguiendo estas 
      líneas:
    </p>
    <pre>
  @Override public String getParameter(String aName) {
  String result = null;
  List&lt;string&gt; values = fRegularParams.get(aName);
  if(values == null){
    //ver si el 'encapsulador' tiene un valor
    String superValue = super.getParameter(aName);
    if(Util.textHasContent(superValue)) {
      result = superValue;
    }
  }
  ...omitido...
}

    </pre>
    <p>
      Finalmente, para un segundo ejemplo de un encapsulador de petición de carga de archivos, vea este 
      <a href="http://www.javaworld.com/jw-06-2001/jw-0622-filters.html?page=5">artículo</a> de Jason Hunter.<br />
    </p>
    <p></p>
    <div class="topic-section" id="see-also-title">Vea También:</div>
    <div id="see-also" class="main-body">
      <a href="../servlets/servlets_218.html">Entender los detalles de las etiquetas FORM</a><br />
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> 
      <span id="app_version_number">3.001</span><br /> © 
      <span id="copyright">2018 Hirondelle Systems</span><br /> 
      <a href="http://www.javapractices.com/source/SourceAction.do">Código Fuente</a> | 
      <a href="mailto:webmaster@javapractices.com" rel="author">Contacto</a> | 
      <a href="http://creativecommons.org/licenses/by-nc-sa/1.0/" rel="license">Licencia</a> | 
      <a href="http://www.javapractices.com/apps/cjp.rss" rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br /> Los trozos de código individual tienen una 
      <a href="http://www.javapractices.com/LICENSE.txt" rel="license">licencia BSD</a><br /> 
      Sobre 1,000,000 de IPs únicas el último año<br /> 
      Última actualización <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time><br />
      - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>