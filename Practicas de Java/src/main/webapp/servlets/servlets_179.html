<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Prácticas y técnicas de programación en Java.">
    <meta name="keywords" content="java, programación java, Prácticas de Java, idioma java, estilo java, patrones de diseño java, 
          convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Practices-&gt;Envíe correos de ticket de problema</title>
    <link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido" style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search" class="search-form" style="float: right;">
        <input name="q" size="15" maxlength="255" placeholder="" type="text" />
        <input name="btnG" value="Search" type="submit" /> 
        <input name="sitesearch" value="www.javapractices.com" type="hidden" />
      </form>
    </nav>
    <div class="page-title">Envíe correos de ticket de problema</div>
    <br />
    En las aplicaciones web, el envío de correos electrónicos es una tarea común.
    <h4>Ejemplo</h4>
    <p>
      Aquí tiene un ejemplo de una clase de utilidad que envía correos electrónicos simple. Puede también validar una dirección de 
      correo electrónico. Usa una entrada en <code>web.xml</code> de un nombre de máquina SMTP.<br />
    </p>
    <pre>
<span class="keyword">import</span> javax.servlet.ServletConfig;
<span class="keyword">import</span> java.util.Properties;

<span class="keyword">import</span> javax.mail.Session;
<span class="keyword">import</span> javax.mail.Transport;
<span class="keyword">import</span> javax.mail.Message;
<span class="keyword">import</span> javax.mail.MessagingException;
<span class="keyword">import</span> javax.mail.internet.InternetAddress;
<span class="keyword">import</span> javax.mail.internet.AddressException;
<span class="keyword">import</span> javax.mail.internet.MimeMessage;

<span class="comment">/**
* Envía un correo electrónico simple del webmaster a un destinatario.
* 
* &lt;P&gt;Los correos electrónicos enviados por esta clase incluyen el remitente, el destinatario, el asunto, y 
* el cuerpo. No se soportan por esta clse características tales como los adjuntos. Si se 
* necesita más flexibilidad, por favor use {@link javax.mail} directamente.
*/</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> Mailer {

  <span class="comment">/**
  * Se llama al inicio, para permitir que esta clase extraiga información 
  * de configuración del servidor de correo desde &lt;code&gt;web.xml&lt;/code&gt;.
  */</span>
  <span class="keyword">public</span> <span class="keyword">static</span> <span
            class="keyword">void</span> init(ServletConfig aConfig){
    fConfig = aConfig;
  }
  
  <span class="comment">/**
  * Valida el formulario de una dirección de correo .
  *
  * &lt;P&gt;Devuelve &lt;code&gt;true&lt;/code&gt; solo si 
  *&lt;ul&gt; 
  * &lt;li&gt; &lt;code&gt;aEmailAddress&lt;/code&gt;puede construir exitosamente una 
  * {@link javax.mail.internet.InternetAddress} 
  * &lt;li&gt; cuando se analiza con un delimitador "@", &lt;code&gt;aEmailAddress&lt;/code&gt; contiene 
  * dos tokens que tienen contenido.
  *&lt;/ul&gt;
  *
  *&lt;P&gt;La segunda condición surge porque las direcciones de correo electrónico locales, simplemente de la forma 
  * "&lt;tt&gt;albert&lt;/tt&gt;", por ejemplo, son válidas pero casi siempre no deseadas.
  */</span>
  <span class="keyword">public</span> <span class="keyword">static</span> <span
            class="keyword">boolean</span> isValidEmailAddress(String aEmailAddress){
    <span class="keyword">if</span> (aEmailAddress == <span
            class="keyword">null</span>) <span class="keyword">return</span> <span
            class="keyword">false</span>;
    
    <span class="keyword">boolean</span> result = <span class="keyword">true</span>;
    <span class="keyword">try</span> {
      InternetAddress emailAddr = <span class="keyword">new</span> InternetAddress(aEmailAddress);
      <span class="keyword">if</span> (! hasNameAndDomain(aEmailAddress)) {
        result = <span class="keyword">false</span>;
      }
    }
    <span class="keyword">catch</span> (AddressException ex){
      result = <span class="keyword">false</span>;
    }
    <span class="keyword">return</span> result;
  }
  
  <span class="comment">/**
  * Envía un correo electrónico a un remitente único, usando una dirección de correo del Webmaster codificada a mano.
  *
  * @param aToAddress satisface {@link #isValidEmailAddress}.
  * @param aSubject tiene contenido.
  * @param aBody tiene contenido.
  */</span>
  <span class="keyword">public</span> <span class="keyword">void</span> send(String aToAddress, String aSubject, String aBody){
    <span class="keyword">if</span> (!textHasContent(aSubject) || !textHasContent(aBody)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span
            class="literal">"Debe tener contenido."</span>);
    }

    <span class="keyword">if</span> (isMailDisabled()){
      log(<span class="literal">"El servicio de correo está deshabilitado."</span>);
      <span class="keyword">return</span>;
    }
    
    Session session = Session.getDefaultInstance( getMailServerConfig(), <span
            class="keyword">null</span> );
    MimeMessage message = <span class="keyword">new</span> MimeMessage( session );
    <span class="keyword">try</span> {
      message.setFrom(<span class="keyword">new</span> InternetAddress(<span
            class="literal">"admin@blah.com"</span>));
      message.addRecipient(Message.RecipientType.TO, <span
            class="keyword">new</span> InternetAddress(aToAddress));
      message.setSubject(aSubject);
      message.setText(aBody);
      Transport.send(message); <span class="comment">//¿seguro en multiproceso?
</span>    }
    <span class="keyword">catch</span> (MessagingException ex){
      log(<span class="literal">"NO PUEDO ENVIAR EL CORREO ELECTRÓNICO."</span> + ex);
    }
    log(<span class="literal">"Se envió el correo electrónico."</span>);
  }
  
  <span class="comment">// PRIVADO
</span>  
  <span class="keyword">private</span> <span class="keyword">static</span> ServletConfig fConfig;
  
  <span class="comment">/**
  * Identifica el elemento en web.xml que contiene el servidor de correo electrónico
  * configurado.
  */</span>
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fMAIL_SERVER = <span
            class="literal">"MailServer"</span>;
  
  <span class="comment">/**
  * Identifica la falta de un servidor de correo configurado en web.xml.
  * Si fMAIL_SERVER toma este valor, entonces el servicio de correo está deshabilitado, y 
  * esta clase abortará todos los intentos de enviar correos electrónicos.
  */</span>
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fNONE = <span
            class="literal">"NINGUNO"</span>;
  
  <span class="keyword">private</span> String getMailServer(){
    <span class="keyword">return</span> fConfig.getServletContext().getInitParameter(fMAIL_SERVER);
  }
  
  <span class="keyword">private</span> <span class="keyword">boolean</span> isMailDisabled(){
    <span class="keyword">return</span> getMailServer().equalsIgnoreCase(fNONE);
  }

  <span class="comment">/**
  * Devuelve el servidor de correo electrónico configurado en la forma de un objeto Properties.
  */</span>
  <span class="keyword">private</span> Properties getMailServerConfig(){
    Properties result = <span class="keyword">new</span> Properties();
    result.put(<span class="literal">"mail.host"</span>, getMailServer());
    <span class="keyword">return</span> result;
  }
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">boolean</span> hasNameAndDomain(String aEmailAddress){
    String[] tokens = aEmailAddress.split(<span class="literal">"@"</span>);
    <span class="keyword">return</span> 
      tokens.length == <span class="literal">2</span> &amp;&amp;
      textHasContent(tokens[<span class="literal">0</span>]) &amp;&amp; 
      textHasContent(tokens[<span class="literal">1</span>])
    ;
  }

  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">void</span> log(Object aObject){
    System.out.println(String.valueOf(aObject));
  }

  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">boolean</span> textHasContent(String aText){
    <span class="keyword">return</span> aText != <span class="keyword">null</span> &amp;&amp; aText.trim().length()&gt;<span
            class="literal">0</span>;
  }
}
  
    </pre>
    <br />
    Un tipo común de correo electrónico es un "ticket de problema", enviado al webmaster cuando ocurre un problema en una 
    aplicación desplegada. Dicho correo electrónico proporciona una lista detallada de información que puede ayudar a resolver el 
    problema. Una clase 
    <code><a href="http://www.web4j.com/web4j/javadoc/hirondelle/web4j/webmaster/TroubleTicket.html">TroubleTicket</a></code> 
    recopilaría dicha información, y se usaría una clase similar al <code>Mailer</code> anterior para enviarla al webmaster.
    <p></p>
    <h4>Ejemplo</h4>
    <p>
      Aquí, un <code>Controller</code> crea y envía un <code>TroubleTicket</code> si 
    </p>
    <ul>
      <li>una <code>Exception</code> inesperada se lanza (ocurre un error)</li>
      <li>el tiempo de respuesta supera algún nivel configurado</li>
    </ul>
    Esta implementación usa una configuración en <code>web.xml</code> para reducir el número excesivo de tickets de problemas 
    similares.
    <br />
    <pre>
<span class="comment">/**
* Servlet Controller.
* Envía un correo electrónico al webmaster cuando ocurre un problema, o cuando el tiempo de respuesta
* excede un valor configurado.
*/</span>
<span class="keyword">public</span> <span class="keyword">class</span> Controller <span
            class="keyword">extends</span> HttpServlet {
  
  <span class="keyword">@Override</span> <span class="keyword">public</span> <span
            class="keyword">final</span> <span class="keyword">void</span> init(ServletConfig aConfig) <span
            class="keyword">throws</span> ServletException {
    <span class="comment">//..omitido
</span>    TroubleTicket.init(aConfig, appInfo);
  }

  <span class="comment">/** Llama a {@link #processRequest}.  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> <span
            class="keyword">final</span> <span class="keyword">void</span> doGet(
    HttpServletRequest aRequest, HttpServletResponse aResponse
  ) <span class="keyword">throws</span> ServletException, IOException {
    processRequest(aRequest, aResponse);
  }

  <span class="comment">/** Llama a {@link #processRequest}.  */</span>
  <span class="keyword">@Override</span> <span class="keyword">public</span> <span
            class="keyword">final</span> <span class="keyword">void</span> doPost(
    HttpServletRequest aRequest, HttpServletResponse aResponse
  ) <span class="keyword">throws</span> ServletException, IOException {
    processRequest(aRequest, aResponse);
  }

  <span class="comment">/**
  * Maneja todas las petciones HTTP &lt;tt&gt;GET&lt;/tt&gt; and &lt;tt&gt;POST&lt;/tt&gt;.
  * 
  * &lt;P&gt;Las operaciones incluyen:
  * &lt;ul&gt;
  * &lt;li&gt;si ocurre un problema inesperado, crea un {@link TroubleTicket}, lo registra, y
  * lo envía por correo electrónico a la dirección de correo del webmaster configurado en &lt;tt&gt;web.xml&lt;/tt&gt;
  * &lt;li&gt;si el tiempo de respuesta excede un umbral configurado, construye un 
  * {@link TroubleTicket}, lo registra, y envía por correo electrónico a la dirección de webmaster configurado 
  * en &lt;tt&gt;web.xml&lt;/tt&gt;
  * &lt;/ul&gt;
  */</span>
  <span class="keyword">protected</span> <span class="keyword">void</span> processRequest(
    HttpServletRequest aRequest, HttpServletResponse aResponse
  ) <span class="keyword">throws</span> ServletException, IOException {
    Stopwatch stopwatch = <span class="keyword">new</span> Stopwatch();
    stopwatch.start();
   
    RequestParser requestParser = RequestParser.getInstance(aRequest, aResponse);
    <span class="keyword">try</span> {
      Action action = requestParser.getWebAction();
      ResponsePage responsePage = action.execute();
      <span class="comment">//..omitido
</span>    }
    <span class="keyword">catch</span> (BadRequestException ex){
      <span class="comment">//..omitido 
</span>    }
    <span class="keyword">catch</span> (Throwable ex) {
      <span class="comment">//Errores O condiciones raras, por ejemplo, falla del almacén de datos
</span>      logAndEmailSeriousProblem(ex, aRequest);
      aResponse.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);
    }
   
    stopwatch.stop();
    <span class="keyword">if</span> (stopwatch.toValue() &gt;= fPOOR_PERFORMANCE_THRESHOLD) {
      logAndEmailPerformanceProblem(stopwatch.toValue(), aRequest);
    }
  }
  
  <span class="comment">/**
  * Informa al webmaster de un problema inesperado con la aplicación desplegada.
  * 
  * &lt;P&gt;Normalmente se llama cuando una &lt;tt&gt;Exception&lt;/tt&gt; ocurre en 
  * {@link #processRequest}. Usa {@link TroubleTicket#mailToWebmaster}.
  * 
  *  &lt;P&gt;También, almacena el ticket de problema en el alcance de la aplicación, para un posible 
  *  examen posterior. 
  */</span>
  <span class="keyword">protected</span> <span class="keyword">final</span> <span
            class="keyword">void</span> logAndEmailSeriousProblem (
    Throwable ex, HttpServletRequest aRequest
  ) <span class="keyword">throws</span> AppException {
    TroubleTicket troubleTicket = <span class="keyword">new</span> TroubleTicket(ex, aRequest);
    fLogger.severe(<span class="literal">"CAPTURA DE NIVEL SUPERIOR Lanzable"</span>);
    fLogger.severe( troubleTicket.toString() ); 
    log(<span class="literal">"OCURRIÓ UN PROBLEMA GRAVE."</span>);
    log( troubleTicket.toString() );
    aRequest.getSession().getServletContext().setAttribute(
      MOST_RECENT_TROUBLE_TICKET, troubleTicket
    );
    troubleTicket.mailToWebmaster();
  }

  <span class="comment">/**
  * Informa al webmaster de un problema de rendimiento.
  * 
  * &lt;P&gt;Llamada solo cuando el tiempo de respuesta de una petición está por encima del valor de umbral 
  * configurado en &lt;tt&gt;web.xml&lt;/tt&gt;.
  * 
  * &lt;P&gt;Construye una &lt;tt&gt;Throwable&lt;/tt&gt; con una descripción del problema, después crea y 
  * envía un correo electrónico con un {@link TroubleTicket} al webmaster.
  * 
  * @param aMilliseconds tiempo de respuesta de una petición en milisegundos
  */</span>
  <span class="keyword">protected</span> <span class="keyword">final</span> <span
            class="keyword">void</span> logAndEmailPerformanceProblem(
    <span class="keyword">long</span> aMilliseconds, HttpServletRequest aRequest
  ) <span class="keyword">throws</span> AppException {
    String message = 
      <span class="literal">"El tiempo de respuesta de la aplicación web supera el umbral de rendimiento configurado."</span> 
      + NEW_LINE + 
      <span class="literal">"Tiempo : "</span> + aMilliseconds + <span
            class="literal">" milisegundos."</span>
    ;
    Throwable ex = <span class="keyword">new</span> Throwable(message);
    TroubleTicket troubleTicket = <span class="keyword">new</span> TroubleTicket(ex, aRequest);
    fLogger.severe(<span class="literal">"Mal tiempo de respuesta: "</span> + aMilliseconds + <span
            class="literal">" milisegundos"</span>);
    fLogger.severe( troubleTicket.toString() ); 
    log(<span class="literal">"Mal tiempo de respuesta: "</span> + aMilliseconds + <span
            class="literal">" milisegundos"</span>);
    log( troubleTicket.toString() );
    troubleTicket.mailToWebmaster();
  }
  
}
 
    </pre>
    <br />
    <p></p>
    <div class="topic-section" id="see-also-title">Vea También:</div>
    <div id="see-also" class="main-body">
      <a href="..\servlets\servlets_107.html">Refactorize los Controladores grandes</a><br /> 
      <a href="..\servlets\servlets_188.html">WEB4J, Un Marco de trabajo de Aplicaciones WEB</a><br /> 
      <a href="..\swing\swing_242.html">Lanzar otras aplicaciones</a>
      <br />
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> 
      <span id="app_version_number">3.001</span><br /> © 
      <span id="copyright">2018 Hirondelle Systems</span><br /> 
      <a href="http://www.javapractices.com/source/SourceAction.do">Código Fuente</a> | 
      <a href="mailto:webmaster@javapractices.com" rel="author">Contacto</a> | 
      <a href="http://creativecommons.org/licenses/by-nc-sa/1.0/" rel="license">Licencia</a> | 
      <a href="http://www.javapractices.com/apps/cjp.rss" rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br /> Los trozos de código individual tienen una 
      <a href="http://www.javapractices.com/LICENSE.txt" rel="license">licencia BSD</a><br /> 
      Sobre 1,000,000 de IPs únicas el último año<br /> 
      Última actualización <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time><br />
      - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>