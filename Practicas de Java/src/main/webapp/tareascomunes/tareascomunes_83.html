<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Prácticas y técnicas de programación en Java.">
    <meta name="keywords" content="java, programación java, Prácticas de Java, idioma java, estilo java, patrones de diseño java, 
          convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prácticas de Java-&gt;Obtener el tamaño de un objeto en memoria</title>
    <link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido" style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search" class="search-form" style="float: right;">
        <input name="q" size="15" maxlength="255" placeholder="" type="text" />
        <input name="btnG" value="Search" type="submit" /> 
        <input name="sitesearch" value="www.javapractices.com" type="hidden" />
      </form>
    </nav>
    <div class="page-title">Obtener el tamaño de un objeto en memoria</div>
    <br /> 
    Ocasionalmente, puede estar interesado en medir (o estimar) el tamaño de un objeto en memoria. Aquí tiene una utilidad que 
    puede ayudar con esa tarea, si la clase del objeto tiene un constructor sin argumento. Sigue el estilo usado por 
    <i>Rendimiento de la Plataforma Java</i>, por Wilson y Kesselman. Dado un nombre de clase, construirá un número de objetos 
    usando el constructor sin argumentos, y mide el efecto en el uso de memoria de la JVM.
    <em>Por lo tanto, mide el tamaño de los objetos "vacíos" que no contienen datos.</em>
    <p>
      Para medir el tamaño de un objeto particular que contiene datos, se puede usar una técnica similar facilmente: mide el uso 
      de memoria de la JVM antes y después de construir el objeto.
    </p>
    <p>
      Además, el KDJ 1.5 ha agragado una interfaz 
      <code>
        <a href="https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/Instrumentation.html">Instrumentation</a>
      </code>, que incluye un método llamado 
      <code>
        <a href="https://docs.oracle.com/javase/10/docs/api/java/lang/instrument/Instrumentation.html#getObjectSize(java.lang.Object)">getObjectSize</a>
      </code>. Sin embargo, este método parece estar dirigido para constructores de herramientas.<br />
    </p>
    <pre>
<span class="comment">/**
* Mide el tamaño aproximado de un objeto en memoria, dada una Class que 
* tiene un constructor sin argumentos.
*/</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> ObjectSizer {

  <span class="comment">/**
  * El primer y único argumento es el nombre calificado por paquete de una clase 
  * que tiene un constructor sin argumentos..
  */</span>
  <span class="keyword">public</span> <span class="keyword">static</span> <span
            class="keyword">void</span> main(String... aArguments){
    Class theClass = <span class="keyword">null</span>;
    <span class="keyword">try</span> {
      theClass = Class.forName(aArguments[<span class="literal">0</span>]);
    }
    <span class="keyword">catch</span> (Exception ex) {
      log(<span class="literal">"No puedo construir un objeto Class: "</span> + aArguments[<span
            class="literal">0</span>]);
      log(<span class="literal">"Use un nombre con cualificación de paquete, y compruebe la ruta de clases."</span>);
    }
    ObjectSizer sizer = <span class="keyword">new</span> ObjectSizer();
    <span class="keyword">long</span> size = sizer.getObjectSize(theClass);
    log(<span class="literal">"Tamaño aproximado de  los objetos "</span> + theClass + <span
            class="literal">" :"</span> + size);
  }

  <span class="comment">/**
  * Devuelve el tamaño aproximado en bytes y devuelve cero si la clase
  * no tiene un constructor por defecto.
  *
  * @param aClass se refiere a una clase que tiene un constructor sin argumento.
  */</span>
  <span class="keyword">public</span> <span class="keyword">long</span> getObjectSize(Class aClass){
    <span class="keyword">long</span> result = <span class="literal">0</span>;

    <span class="comment">//si la clase no tiene un constructor sin argumentos, entonces 
</span>    <span class="comment">//informa al usuario y devuelve 0.
</span>    <span class="keyword">try</span> {
      aClass.getConstructor(<span class="keyword">new</span> Class[]{});
    }
    <span class="keyword">catch</span> (NoSuchMethodException ex) {
      log(aClass + <span class="literal">" no tiene un constructor sin argumentos."</span>);
      <span class="keyword">return</span> result;
    }

    <span class="comment">//esta matriz mantendrá simplemente un montón de referencias, de forma que 
</span>    <span class="comment">//los objetos no puedan ser recolectados para la basura
</span>    Object[] objects = <span class="keyword">new</span> Object[fSAMPLE_SIZE];

    <span class="comment">//construye un montón de objetos idénticos
</span>    <span class="keyword">try</span> {
      Object throwAway = aClass.newInstance();

      <span class="keyword">long</span> startMemoryUse = getMemoryUse();
      <span class="keyword">for</span> (<span class="keyword">int</span> idx=<span
            class="literal">0</span>; idx &lt; objects.length ; ++idx) {
        objects[idx] = aClass.newInstance();
      }
      <span class="keyword">long</span> endMemoryUse = getMemoryUse();

      <span class="keyword">float</span> approximateSize = (endMemoryUse - startMemoryUse)/<span
            class="literal">100f</span>;
      result = Math.round(approximateSize);
    }
    <span class="keyword">catch</span> (Exception ex) {
      log(<span class="literal">"No puede crear un objeto usando "</span> + aClass);
    }
    <span class="keyword">return</span> result;
  }

  <span class="comment">// PRIVADO
</span>  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">int</span> fSAMPLE_SIZE = <span
            class="literal">100</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">long</span> fSLEEP_INTERVAL = <span
            class="literal">100</span>;

  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">void</span> log(String aMessage){  
    System.out.println(aMessage);  
  }
  
  <span class="keyword">private</span> <span class="keyword">long</span> getMemoryUse(){
    putOutTheGarbage();
    <span class="keyword">long</span> totalMemory = Runtime.getRuntime().totalMemory();
    putOutTheGarbage();
    <span class="keyword">long</span> freeMemory = Runtime.getRuntime().freeMemory();
    <span class="keyword">return</span> (totalMemory - freeMemory);
  }

  <span class="keyword">private</span> <span class="keyword">void</span> putOutTheGarbage() {
    collectGarbage();
    collectGarbage();
  }

  <span class="keyword">private</span> <span class="keyword">void</span> collectGarbage() {
    <span class="keyword">try</span> {
      System.gc();
      Thread.currentThread().sleep(fSLEEP_INTERVAL);
      System.runFinalization();
      Thread.currentThread().sleep(fSLEEP_INTERVAL);
    }
    <span class="keyword">catch</span> (InterruptedException ex){
      ex.printStackTrace();
    }
  }
} 
    </pre>
    <p></p>
    <p>
      <code>ObjectSizer</code> puede ser colocada fácilmente en una aplicación de consola interactiva.
    </p>
    <p>
      Una ejecución de ejemplo da:
    </p>
    <p>
      <code>&gt;java -cp . Console ObjectSizeInterpreter</code><br />
      <code>Ingrese un nombre de clase&gt;java.blah</code><br />
      <code>Invalido. Ejemplo:"java.lang.String"&gt;java.util.ArrayList</code><br />
      <code>Tamaño aproximado de los objetos de la clase java.util.ArrayList en bytes: 80</code><br />
      <code>Ingrese un nombre de clase&gt;java.util.Vector</code><br />
      <code>Tamaño aproximado de los objetos de la clase java.util.Vector en bytes: 80</code><br />
      <code>Ingrese un nombre de clase&gt;java.util.HashMap</code><br />
      <code>Tamaño aproximado de los objetos de la clase java.util.HashMap en bytes: 104</code><br />
      <code>Ingrese un nombre de clase&gt;java.lang.Long</code><br />
      <code>La clase java.lang.Long no tiene un constructor sin argumentos.</code><br />
      <code>Ingrese un nombre de clase&gt;exit</code>
    </p>
    <p>
      <code>Adios.</code>
    </p>
    <p>
      Aquí está la clase <code>Interpreter</code>: <br />
    </p>
    <pre>
<span class="keyword">import</span> java.util.*;
<span class="keyword">import</span> java.text.MessageFormat;

<span class="comment">/**
* Dado un nombre de clase cualificado de paquete, devuelve el tamaño aproximado del 
* objeto en bytes.
*/</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> ObjectSizeInterpreter <span
            class="keyword">implements</span> Interpreter {

  <span class="comment">/**
  * @param aLine es el nombre cualificado de paqute no nulo de una clase.
  * @param aResult es una List vacía, no nula que actúa como un parámetro de 
  *  "salida"; cuando se devuelve, aResult debe contener una List 
  * no nula y no vacía que contiene una descripción del tamaño del objeto.
  *
  * @return true solo si el usuario ha solicitado salir de Interpreter.
  * @exception IllegalArgumentException si un parámeto no cumple.
  */</span>
  <span class="keyword">public</span> <span class="keyword">boolean</span> parseInput(String  aLine, <span
            class="keyword">final</span> List&lt;Object&gt; aResult) {
    <span class="keyword">if</span> (aResult == <span class="keyword">null</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span
            class="literal">"El parámetro Result no puede ser nulo."</span>);
    }
    <span class="keyword">if</span> (!aResult.isEmpty()){
      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span
            class="literal">"El parámetro Result debe estar vacío."</span>);
    }
    <span class="keyword">if</span> (aLine == <span class="keyword">null</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span
            class="literal">"Line no puede ser nula."</span>);
    }

    <span class="keyword">boolean</span> hasRequestedQuit = 
      aLine.trim().equalsIgnoreCase(fQUIT) ||
      aLine.trim().equalsIgnoreCase(fEXIT)
    ;

    <span class="keyword">if</span> (hasRequestedQuit) {
      <span class="comment">//visualiza solo una linea en blanco
</span>      aResult.add(fNEW_LINE);
    }
    <span class="keyword">else</span> {
      <span class="keyword">try</span> {
        Class theClass = Class.forName(aLine);
        ObjectSizer sizer = <span class="keyword">new</span> ObjectSizer();
        <span class="keyword">long</span> size = sizer.getObjectSize(theClass);
        <span class="keyword">if</span> (size &gt; <span class="literal">0</span>){
          Object[] insertedData = {theClass, <span class="keyword">new</span> Long(size)};
          MessageFormat sizeMessage = <span class="keyword">new</span> MessageFormat(fPATTERN);
          String message = sizeMessage.format(insertedData);
          aResult.add(message);
          aResult.add(fNEW_LINE);
        }
        aResult.add(fDEFAULT_PROMPT);
      }
      <span class="keyword">catch</span> (ClassNotFoundException ex){
        <span class="comment">//Recupera pidiendo al usuario la entrada corregida
</span>        aResult.clear();
        aResult.add(fERROR_PROMPT);
      }
    }

    <span class="keyword">if</span> (aResult.isEmpty()) {
      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span
            class="literal">"Result no debe estar vacío."</span>);
    }
    <span class="keyword">return</span> hasRequestedQuit;
  }

  <span class="comment">/**
  * Devuelve el texto que se mostrará al iniciar el interprete.
  */</span>
  <span class="keyword">public</span> String getHelloPrompt() {
    <span class="keyword">return</span> fHELLO_PROMPT;
  }

  <span class="comment">// PRIVADO
</span>  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fHELLO_PROMPT = <span
            class="literal">"Ingrese un nombre de clase&gt;"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fDEFAULT_PROMPT = <span
            class="literal">"Ingrese un nombre de clase&gt;"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fERROR_PROMPT = <span
            class="literal">"Inválido. Ejemplo:\"java.lang.String\"&gt;"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fPATTERN = <span
            class="literal">"Tamaño aproximado de {0} objetos en bytes: {1}"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fQUIT = <span
            class="literal">"quit"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fEXIT = <span
            class="literal">"exit"</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> String fNEW_LINE = System.getProperty(<span
            class="literal">"line.separator"</span>);
} 
    </pre>
    <br />
    <p></p>
    <p></p>
    <div class="topic-section" id="see-also-title">
      Vea También :
    </div>
    <div id="see-also" class="main-body">
      <a href="../tareascomunes/tareascomunes_36.html">Mide el rendimiento de la aplicación</a> <br />
      <a href="../entradasalida/entradasalida_79.html">Entrada en la Consola</a> <br />
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> 
      <span id="app_version_number">3.001</span><br /> © 
      <span id="copyright">2018 Hirondelle Systems</span><br /> 
      <a href="http://www.javapractices.com/source/SourceAction.do">Código Fuente</a> | 
      <a href="mailto:webmaster@javapractices.com" rel="author">Contacto</a> | 
      <a href="http://creativecommons.org/licenses/by-nc-sa/1.0/" rel="license">Licencia</a> | 
      <a href="http://www.javapractices.com/apps/cjp.rss" rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br /> Los trozos de código individual tienen una 
      <a href="http://www.javapractices.com/LICENSE.txt" rel="license">licencia BSD</a><br /> 
      Sobre 1,000,000 de IPs únicas el último año<br /> 
      Última actualización <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time><br />
      - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>