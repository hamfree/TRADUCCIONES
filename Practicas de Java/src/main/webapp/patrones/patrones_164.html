<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description"
          content="Prácticas y técnicas de programación en Java.">
    <meta name="keywords"
          content="java,programación java,Prácticas de Java,idioma 
          java,estilo java,patrones de diseño java,convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prácticas de Java-&gt;Método Template</title>
    <link id="stylesheet" rel="stylesheet" type="text/css"
          href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido"
         style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search"
            class="search-form" style="float: right;">
        <input name="q" size="15" maxlength="255" placeholder=""
               type="text"> <input name="btnG" value="Search"
               type="submit"> <input name="sitesearch"
               value="www.javapractices.com" type="hidden">
      </form>
    </nav>
    <div class="page-title">Método Template</div>
    <br>Template methods:
    <ul>
      <li>are used in most abstract base classes</li>
      <li>are perhaps the most commonly used of all design
        patterns</li>
      <li>define the general steps of a method, while deferring
        the implementation of at least one of the steps to a
        concrete subclass</li>
    </ul>
    <b>Example</b>
    <p>
      <code>TxTemplate</code>
      is an abstract base class which defines a template method for
      executing multiple database operations within a transaction.
      It's useful to define these steps in one place. The alternative
      is to repeat the same structure every time a transaction is
      required. As usual, such code repetition should always be
      aggressively eliminated.
    </p>
    <p>
      The
      <code>executeTx</code>
      method is the template method. It's
      <code>final</code>
      , and defines the general outline of how to execute a database
      transaction. The specific database actions to be taken are
      implemented by calling the
      <code>abstract</code>
      method
      <code>executeMultipleSqls</code>
      . <br>
    </p>
    <pre>
		<span class="keyword">import</span> java.sql.*;
<span class="keyword">import</span> java.util.logging.*;

<span class="keyword">import</span> hirondelle.web4j.BuildImpl;
<span class="keyword">import</span> hirondelle.web4j.util.Util;
<span class="keyword">import</span> hirondelle.web4j.util.Consts;

<span class="comment">/** 
* Template for executing a local, non-distributed transaction versus a 
* single database, using a single connection.
*
* &lt;P&gt;This abstract base class implements the template method design pattern.
*/</span>
<span class="keyword">public</span> <span class="keyword">abstract</span> <span
            class="keyword">class</span> TxTemplate <span
            class="keyword">implements</span> Tx {
  
  <span class="comment">//..elided
</span>  
  <span class="comment">/**
  * &lt;b&gt;Template&lt;/b&gt; method calls the abstract method {@link #executeMultipleSqls}.
  * &lt;P&gt;Returns the same value as &lt;tt&gt;executeMultipleSqls&lt;/tt&gt;.
  *
  * &lt;P&gt;A &lt;tt&gt;rollback&lt;/tt&gt; is performed if &lt;tt&gt;executeMultipleSqls&lt;/tt&gt; fails.
  */</span>
  <span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">int</span> executeTx() <span class="keyword">throws</span> DAOException {
    <span class="keyword">int</span> result = <span class="literal">0</span>;
    fLogger.fine(
      <span class="literal">"Editing within a local transaction, with isolation level : "</span> + fTxIsolationLevel
    );
    ConnectionSource connSource = BuildImpl.forConnectionSource();
    <span class="keyword">if</span>(Util.textHasContent(fDatabaseName)){
      fConnection = connSource.getConnection(fDatabaseName);
    }
    <span class="keyword">else</span> {
      fConnection = connSource.getConnection();
    }
    
    <span class="keyword">try</span> {
      TxIsolationLevel.set(fTxIsolationLevel, fConnection);
      startTx();
      result = executeMultipleSqls(fConnection);
      endTx(result);
    }
    <span class="keyword">catch</span>(SQLException rootCause){
      fLogger.fine(<span class="literal">"Transaction throws SQLException."</span>);
      rollbackTx();
      String message = 
        <span class="literal">"Cannot execute edit. ErrorId code : "</span> +  rootCause.getErrorCode() + 
        Consts.SPACE + rootCause
      ;
      <span class="keyword">if</span> (rootCause.getErrorCode() == DbConfig.getErrorCodeForDuplicateKey().intValue()){
        <span class="keyword">throw</span> <span class="keyword">new</span> DuplicateException(message, rootCause);
      }
      <span class="keyword">throw</span> <span class="keyword">new</span> DAOException(message, rootCause);
    }
    <span class="keyword">catch</span> (DAOException ex){
      fLogger.fine(<span class="literal">"Transaction throws DAOException."</span>);
      rollbackTx();
      <span class="keyword">throw</span> ex;
    }
    <span class="keyword">finally</span> {
      DbUtil.logWarnings(fConnection);
      DbUtil.close(fConnection);
    }
    fLogger.fine(<span class="literal">"Total number of edited records: "</span> + result);
    <span class="keyword">return</span> result;
  }

  <span class="comment">/**
  * Execute multiple SQL operations in a single local transaction.
  *
  * &lt;P&gt;This method returns the number of records edited. 
  */</span>
  <span class="keyword">public</span> <span class="keyword">abstract</span> <span
            class="keyword">int</span> executeMultipleSqls(
    Connection aConnection
  ) <span class="keyword">throws</span> SQLException, DAOException;
  
  <span class="comment">// PRIVATE
</span>  
  <span class="keyword">private</span> Connection fConnection;
  <span class="keyword">private</span> String fDatabaseName;
  <span class="keyword">private</span> <span class="keyword">final</span> TxIsolationLevel fTxIsolationLevel;
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">boolean</span> fOFF = <span
            class="keyword">false</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">boolean</span> fON = <span
            class="keyword">true</span>;
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> Logger fLogger = Util.getLogger(TxTemplate.<span
            class="keyword">class</span>);  

  <span class="keyword">private</span> <span class="keyword">void</span> startTx() <span
            class="keyword">throws</span> SQLException {
    fConnection.setAutoCommit(fOFF);
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> endTx(<span
            class="keyword">int</span> aNumEdits) <span class="keyword">throws</span> SQLException, DAOException {
    <span class="keyword">if</span> ( BUSINESS_RULE_FAILURE == aNumEdits ) {
      fLogger.severe(<span class="literal">"Business rule failure occured. Cannot commit transaction."</span>);
      rollbackTx();
    }
    <span class="keyword">else</span> {
      fLogger.fine(<span class="literal">"Commiting transaction."</span>);
      fConnection.commit();
      fConnection.setAutoCommit(fON);
    }
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> rollbackTx() <span
            class="keyword">throws</span> DAOException {
    fLogger.severe(<span class="literal">"ROLLING BACK TRANSACTION."</span>);
    <span class="keyword">try</span> {
      fConnection.rollback();
    }
    <span class="keyword">catch</span>(SQLException ex){
      <span class="keyword">throw</span> <span class="keyword">new</span> DAOException(<span
            class="literal">"Cannot rollback transaction"</span>, ex);
    }
  }
}
 
    </pre>
    <br>Here's an example of using
    <code>TxTemplate</code>
    . It alters the set of roles attached to an end user, first by
    deleting all existing roles, and then by adding the new roles one at
    a time.
    <br>
    <pre>
		<span class="keyword">final</span> <span class="keyword">class</span> RoleDAO {

  <span class="comment">//..elided  
</span>
  <span class="comment">/**
  * Update all roles attached to a user.
  * 
  * &lt;P&gt;This implementation will treat all edits to user roles as 
  * '&lt;tt&gt;DELETE-ALL&lt;/tt&gt;, then &lt;tt&gt;ADD-ALL&lt;/tt&gt;' operations. 
  */</span>
  <span class="keyword">boolean</span> change(UserRole aUserRole) <span
            class="keyword">throws</span> DAOException {
    Tx update = <span class="keyword">new</span> UpdateTransaction(aUserRole);
    <span class="keyword">return</span> Util.isSuccess(update.executeTx());
  }
  
  <span class="comment">// PRIVATE //
</span>  
  <span class="comment">/** Cannot be a {@link hirondelle.web4j.database.TxSimple}, since there is looping. */</span>
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">class</span> UpdateTransaction <span
            class="keyword">extends</span> TxTemplate {
    UpdateTransaction(UserRole aUserRole){
      <span class="keyword">super</span>(ConnectionSrc.ACCESS_CONTROL);
      fUserRole = aUserRole;
    }
    <span class="keyword">public</span> <span class="keyword">int</span> executeMultipleSqls(
      Connection aConnection
    ) <span class="keyword">throws</span> SQLException, DAOException {
      <span class="keyword">int</span> result = <span class="literal">0</span>;
      <span class="comment">//perform edits using a shared connection
</span>      result = result + DbTx.edit(aConnection, ROLES_DELETE, fUserRole.getUserName());
      <span class="keyword">for</span>(Id roleId : fUserRole.getRoles()){
        result = result + DbTx.edit(aConnection,ROLES_ADD,fUserRole.getUserName(),roleId);
      }
      <span class="keyword">return</span> result;
    }
    <span class="keyword">private</span> UserRole fUserRole;
  }
}
 
    </pre>
    <br>
    <p></p>
    <p></p>
    <div class="topic-section" id="see-also-title">See Also :</div>
    <div id="see-also" class="main-body">
      <a href="..\herencia\inheritance_72.html">"Considere la
        composición en lugar de hacer subclases"</a> <br> <a
        href="..\patrones\patrones_139.html">Objetos Command</a> <br> <a
        href="..\patrones\patrones_258.html">Envoltorio (Decorador)</a> <br>
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> <span
        id="app_version_number">3.001</span><br> © <span
        id="copyright">2018 Hirondelle Systems</span><br> <a
        href="http://www.javapractices.com/source/SourceAction.do">Código
        Fuente</a> | <a href="mailto:webmaster@javapractices.com"
                      rel="author">Contacto</a> | <a
                      href="http://creativecommons.org/licenses/by-nc-sa/1.0/"
                      rel="license">Licencia</a> | <a
                      href="http://www.javapractices.com/apps/cjp.rss"
                      rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br> Los trozos de código individual tienen una <a
        href="http://www.javapractices.com/LICENSE.txt"
        rel="license">licencia BSD</a><br> Sobre 1,000,000 de
      IPs únicas el último año<br> Última actualización
      <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time>
      <br> - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>