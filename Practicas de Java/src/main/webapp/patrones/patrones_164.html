<!DOCTYPE html>
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Prácticas y técnicas de programación en Java.">
    <meta name="keywords" content="java, programación java, Prácticas de Java, idioma java, estilo java, patrones de diseño java, 
          convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prácticas de Java-&gt;Método Template</title>
    <link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido" style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search" class="search-form" style="float: right;">
        <input name="q" size="15" maxlength="255" placeholder="" type="text" />
        <input name="btnG" value="Búsqueda" type="submit" /> 
        <input name="sitesearch" value="www.javapractices.com" type="hidden" />
      </form>
    </nav>
    <div class="page-title">
      Método Template
    </div>
    <br />
    Los métodos Template (Plantilla, en español):
    <ul>
      <li>se usan en la mayoría de las clases base abstractas</li>
      <li>son quizás los más utilizados de todos los patrones de diseño</li>
      <li>
        define los pasos generales de un método, mientras pospone la implementación de al menos uno de los pasos a una subclase 
        concreta
      </li>
    </ul>
    <b>Ejemplo</b>
    <p>
      <code>TxTemplate</code> es una clase base abstracta que define un método template para ejecutar múltiples operaciones en 
      base de datos dentro de una abstracción. Es útil definir estos pasos en un lugar. La alternativa es repetir la misma 
      estructura cada vez que se requiere una transacción. Como es habitual, dicha repetición de código debería siempre ser 
      eliminada agresivamente.
    </p>
    <p>
      El método <code>executeTx</code> es el método template. Es <code>final</code>, y define el esquema general de cómo ejecutar 
      una transacción de base de datos. Las acciones específicas de base de datos que se deben tomar se implementan llamando al 
      método <code>abstract</code> <code>executeMultipleSqls</code>.<br />
    </p>
    <pre>
<span class="keyword">import</span> java.sql.*;
<span class="keyword">import</span> java.util.logging.*;

<span class="keyword">import</span> hirondelle.web4j.BuildImpl;
<span class="keyword">import</span> hirondelle.web4j.util.Util;
<span class="keyword">import</span> hirondelle.web4j.util.Consts;

<span class="comment">/** 
* Plantilla para ejecutar una transacción local, no distribuida contra una 
* única base de datos, usando una conexión única.
*
* &lt;P&gt;Esta clase base abstracta implementa el patrón de diseño de método template.
*/</span>
<span class="keyword">public</span> <span class="keyword">abstract</span> <span
            class="keyword">class</span> TxTemplate <span
            class="keyword">implements</span> Tx {
  
  <span class="comment">//..omitido
</span>  
  <span class="comment">/**
  * El método &lt;b&gt;Template&lt;/b&gt; llama al método abstracto {@link #executeMultipleSqls}.
  * &lt;P&gt;Devuelve el mismo valor como &lt;tt&gt;executeMultipleSqls&lt;/tt&gt;.
  *
  * &lt;P&gt;Se realiza un &lt;tt&gt;rollback&lt;/tt&gt; si &lt;tt&gt;executeMultipleSqls&lt;/tt&gt; falla.
  */</span>
  <span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">int</span> executeTx() <span class="keyword">throws</span> DAOException {
    <span class="keyword">int</span> result = <span class="literal">0</span>;
    fLogger.fine(
      <span class="literal">"Edición dentro de una transacción local, con nivel de aislamiento: "</span> + fTxIsolationLevel
    );
    ConnectionSource connSource = BuildImpl.forConnectionSource();
    <span class="keyword">if</span>(Util.textHasContent(fDatabaseName)){
      fConnection = connSource.getConnection(fDatabaseName);
    }
    <span class="keyword">else</span> {
      fConnection = connSource.getConnection();
    }
    
    <span class="keyword">try</span> {
      TxIsolationLevel.set(fTxIsolationLevel, fConnection);
      startTx();
      result = executeMultipleSqls(fConnection);
      endTx(result);
    }
    <span class="keyword">catch</span>(SQLException rootCause){
      fLogger.fine(<span class="literal">"Transacción lanza SQLException."</span>);
      rollbackTx();
      String message = 
        <span class="literal">"No se puede ejecutar la edición. Código de errorId : "</span> +  rootCause.getErrorCode() + 
        Consts.SPACE + rootCause
      ;
      <span class="keyword">if</span> (rootCause.getErrorCode() == DbConfig.getErrorCodeForDuplicateKey().intValue()){
        <span class="keyword">throw</span> <span class="keyword">new</span> DuplicateException(message, rootCause);
      }
      <span class="keyword">throw</span> <span class="keyword">new</span> DAOException(message, rootCause);
    }
    <span class="keyword">catch</span> (DAOException ex){
      fLogger.fine(<span class="literal">"Transacción lanza DAOException."</span>);
      rollbackTx();
      <span class="keyword">throw</span> ex;
    }
    <span class="keyword">finally</span> {
      DbUtil.logWarnings(fConnection);
      DbUtil.close(fConnection);
    }
    fLogger.fine(<span class="literal">"Número total de registros editados: "</span> + result);
    <span class="keyword">return</span> result;
  }

  <span class="comment">/**
  * Ejecute múltiples operaciones SQL en una sola transacción local.
  *
  * &lt;P&gt;Este método devuelve el número de registros editados.
  */</span>
  <span class="keyword">public</span> <span class="keyword">abstract</span> <span
            class="keyword">int</span> executeMultipleSqls(
    Connection aConnection
  ) <span class="keyword">throws</span> SQLException, DAOException;
  
  <span class="comment">// PRIVADO
</span>  
  <span class="keyword">private</span> Connection fConnection;
  <span class="keyword">private</span> String fDatabaseName;
  <span class="keyword">private</span> <span class="keyword">final</span> TxIsolationLevel fTxIsolationLevel;
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">boolean</span> fOFF = <span
            class="keyword">false</span>;
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">boolean</span> fON = <span
            class="keyword">true</span>;
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> Logger fLogger = Util.getLogger(TxTemplate.<span
            class="keyword">class</span>);  

  <span class="keyword">private</span> <span class="keyword">void</span> startTx() <span
            class="keyword">throws</span> SQLException {
    fConnection.setAutoCommit(fOFF);
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> endTx(<span
            class="keyword">int</span> aNumEdits) <span class="keyword">throws</span> SQLException, DAOException {
    <span class="keyword">if</span> ( BUSINESS_RULE_FAILURE == aNumEdits ) {
      fLogger.severe(<span class="literal">"Ocurrió una falla en las reglas comerciales. No se puede confirmar la transacción."</span>);
      rollbackTx();
    }
    <span class="keyword">else</span> {
      fLogger.fine(<span class="literal">"Realizando transacción."</span>);
      fConnection.commit();
      fConnection.setAutoCommit(fON);
    }
  }
  
  <span class="keyword">private</span> <span class="keyword">void</span> rollbackTx() <span
            class="keyword">throws</span> DAOException {
    fLogger.severe(<span class="literal">"SE REVIERTE LA TRANSACCIÓN."</span>);
    <span class="keyword">try</span> {
      fConnection.rollback();
    }
    <span class="keyword">catch</span>(SQLException ex){
      <span class="keyword">throw</span> <span class="keyword">new</span> DAOException(<span
            class="literal">"No se puede revertir la transacción"</span>, ex);
    }
  }
}
 
    </pre>
    <br />
    Aquí tiene un ejemplo usando <code>TxTemplate</code>. Altera el conjunto de roles vinculados a un usuario final, borrando 
    primero todos los roles existentes, y después agregando los nuevos roles de una vez.
    <br />
    <pre>
<span class="keyword">final</span> <span class="keyword">class</span> RoleDAO {

  <span class="comment">//..omitido  
</span>
  <span class="comment">/**
  * Actualiza todos los roles vinculados a un usuario.
  * 
  * &lt;P&gt;Esta implementación tratará todas las ediciones a los roles del usuario como operaciones 
  * '&lt;tt&gt;DELETE-ALL&lt;/tt&gt;, y después &lt;tt&gt;ADD-ALL&lt;/tt&gt;'. 
  */</span>
  <span class="keyword">boolean</span> change(UserRole aUserRole) <span
            class="keyword">throws</span> DAOException {
    Tx update = <span class="keyword">new</span> UpdateTransaction(aUserRole);
    <span class="keyword">return</span> Util.isSuccess(update.executeTx());
  }
  
  <span class="comment">// PRIVADO //
</span>  
  <span class="comment">/** No puede ser un {@link hirondelle.web4j.database.TxSimple}, ya que hay bucles. */</span>
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">class</span> UpdateTransaction <span
            class="keyword">extends</span> TxTemplate {
    UpdateTransaction(UserRole aUserRole){
      <span class="keyword">super</span>(ConnectionSrc.ACCESS_CONTROL);
      fUserRole = aUserRole;
    }
    <span class="keyword">public</span> <span class="keyword">int</span> executeMultipleSqls(
      Connection aConnection
    ) <span class="keyword">throws</span> SQLException, DAOException {
      <span class="keyword">int</span> result = <span class="literal">0</span>;
      <span class="comment">//realizar ediciones usando una conexión compartida
</span>      result = result + DbTx.edit(aConnection, ROLES_DELETE, fUserRole.getUserName());
      <span class="keyword">for</span>(Id roleId : fUserRole.getRoles()){
        result = result + DbTx.edit(aConnection,ROLES_ADD,fUserRole.getUserName(),roleId);
      }
      <span class="keyword">return</span> result;
    }
    <span class="keyword">private</span> UserRole fUserRole;
  }
}
 
    </pre>
    <br />
    <p></p>
    <p></p>
    <div class="topic-section" id="see-also-title">
      Vea También :
    </div>
    <div id="see-also" class="main-body">
      <a href="../herencia/inheritance_72.html">"Considere la composición en lugar de hacer subclases"</a><br /> 
      <a href="../patrones/patrones_139.html">Objetos Command</a><br /> 
      <a href="../patrones/patrones_258.html">Envoltorio (Decorador)</a><br />
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> 
      <span id="app_version_number">3.001</span><br /> © 
      <span id="copyright">2018 Hirondelle Systems</span><br /> 
      <a href="http://www.javapractices.com/source/SourceAction.do">Código Fuente</a> | 
      <a href="mailto:webmaster@javapractices.com" rel="author">Contacto</a> | 
      <a href="http://creativecommons.org/licenses/by-nc-sa/1.0/" rel="license">Licencia</a> | 
      <a href="http://www.javapractices.com/apps/cjp.rss" rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br /> Los trozos de código individual tienen una 
      <a href="http://www.javapractices.com/LICENSE.txt" rel="license">licencia BSD</a><br /> 
      Sobre 1,000,000 de IPs únicas el último año<br /> 
      Última actualización <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time><br />
      - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>