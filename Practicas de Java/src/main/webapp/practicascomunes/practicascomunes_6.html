<!DOCTYPE html>
<!-- saved from url=(0054)http://www.javapractices.com/topic/TopicAction.do?Id=6 -->
<html lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="Presentaciones concisas de prácticas de programación en java, tareas, y convenciones, 
          ampliamente ilustrado con ejemplos de código con resaltado de sintaxis.">
    <meta name="keywords" content="java, programación java, Prácticas de Java, idioma java, estilo java, patrones de diseño java, 
          convenciones de codigo java">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prácticas de Java-&gt;Validar el estado con invariantes de clase</title>
    <link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet9.css" media="all">
    <link rel="icon" type="image/png" href="../img/favicon.png">
  </head>
  <body>
    <nav class="menu-bar" id="menu-bar">
      <a href="../index.html" title="Tabla de Contenido" style="float: left;">Inicio</a> &nbsp;&nbsp;
      <form method="GET" action="https://www.google.com/search" class="search-form" style="float: right;">
        <input type="text" name="q" size="15" maxlength="255" value="" placeholder=""/> 
        <input type="submit" name="btnG" value="Search" /> 
        <input type="hidden" name="sitesearch" value="www.javapractices.com" />
      </form>
    </nav>
    <div class="page-title">Validar el estado con invariantes de clase</div>
    <br />
    Las clases invariantes son métodos que comprueban la validez del estado de un objeto (sus datos). La idea es definir métodos de
    validación para los campos, y realizar estas validaciones siempre que los campos cambien. Como es usual, esto debería ser 
    realizado sin repetir ningún código.
    <p>
      Un estado de objeto puede convertirse en inválido por varios razones:
    </p>
    <p>
      <b>Se pasa un argumento no válido por el llamador.</b> <br />Para asegurar que el llamador cumple con los requisitos de un 
      método o constructor, todos los <a href="practicascomunes_5.html">argumentos a los métodos no 
        privados deben ser explícitamente comprobados</a>. Una excepción debe ser lanzada si un problema se detecta. Un caso 
        especial es la <a href="../index.html#Serialization">deserialización</a>, que debe
        tratar <code>readObject</code> como un constructor. (Las aserciones 
        <a href="../aserciones/aserciones_100.html">no se deben usar</a> para estos tipos de comprobaciones).
    </p>
    <p>
      <b>La implementación de la clase es defectuosa.</b> <br />
      Como medida defensiva, un método que cambia el estado de un objeto puede incluir una 
      <a href="../index.html#Assertions">aserción</a> en su final, para comprobar que el objeto de hecho permaneció en un estado 
      válido. Aquí, tales aserciones verifican la exactitud de los detalles de implementación interna, no verifican los argumentos.
    </p>
    <p>
      <b>Ejemplo 1</b>
    </p>
    <p>
      <code>Resto</code> es un <a href="../patrones/patrones_187.html">Modelo de Objetos</a> (MO) 
      inmutable. Esta clase invariante se define por el método <code>validateState</code>. En este caso particular, si la 
      validación falla una excepción comprobada se lanza, y el usuario final se presenta con su entrada original, junto con los 
      mensajes de error asociados.
    </p>
    <p>
      Tales clases inmutables representan el caso más simple, ya que la validación se realizó solo una vez, durante la construcción
      (y la deserialización, si es necesario). Por definición, un 
      <a href="http://www.javapractices.com/topic/TopicAction.do?Id=29">objeto inmutable</a> no puede cambiar el estado después 
      de la construcción, por lo que nunca es necesario realizar validaciones en otros momentos de la vida del objeto.<br />
    </p>
    <pre>
<span class="keyword">package</span> hirondelle.fish.main.resto;

<span class="keyword">import</span> hirondelle.web4j.model.ModelCtorException;
<span class="keyword">import</span> hirondelle.web4j.model.ModelUtil;
<span class="keyword">import</span> hirondelle.web4j.model.Id;
<span class="keyword">import</span> hirondelle.web4j.security.SafeText;
<span class="keyword">import</span> hirondelle.web4j.model.Decimal;
<span class="keyword">import</span> <span class="keyword">static</span> hirondelle.web4j.model.Decimal.ZERO;
<span class="keyword">import</span> hirondelle.web4j.model.Check;
<span class="keyword">import</span> hirondelle.web4j.model.Validator;
<span class="keyword">import</span> <span class="keyword">static</span> hirondelle.web4j.util.Consts.FAILS;

<span class="comment">/** Modelo de Objetos para un Restaurante. */</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> Resto {

  <span class="comment">/**
   Constructore completo.
    
   @param aId identificador interno de la base de datos subyacente (opcional) 1..50 carácteres
   @param aName del restaurante (requerido), 2..50 caracteres
   @param aLocation dirección de la calle del restaurante (opcional), 2..50 caracteres
   @param aPrice de la comida de pescado y patatas (opcional) $0.00..$100.00
   @param aComment sobre el restaurante en general (opcional) 2..50 caracteres
  */</span>
  <span class="keyword">public</span> Resto(
    Id aId, SafeText aName, SafeText aLocation, Decimal aPrice, SafeText aComment
  ) <span class="keyword">throws</span> ModelCtorException {
    fId = aId;
    fName = aName;
    fLocation = aLocation;
    fPrice = aPrice;
    fComment = aComment;
    validateState();
  }
  
  <span class="keyword">public</span> Id getId() { <span class="keyword">return</span> fId; }
  <span class="keyword">public</span> SafeText getName() {  <span
            class="keyword">return</span> fName; }
  <span class="keyword">public</span> SafeText getLocation() {  <span
            class="keyword">return</span> fLocation;  }
  <span class="keyword">public</span> Decimal getPrice() { <span
            class="keyword">return</span> fPrice; }
  <span class="keyword">public</span> SafeText getComment() {  <span
            class="keyword">return</span> fComment; }

  <span class="keyword">@Override</span> <span class="keyword">public</span> String toString(){
    <span class="keyword">return</span> ModelUtil.toStringFor(<span
            class="keyword">this</span>);
  }
  
  <span class="keyword">@Override</span> <span class="keyword">public</span>  <span
            class="keyword">boolean</span> equals(Object aThat){
    Boolean result = ModelUtil.quickEquals(<span class="keyword">this</span>, aThat);
    <span class="keyword">if</span> (result ==  <span class="keyword">null</span>) {
      Resto that = (Resto) aThat;
      result = ModelUtil.equalsFor(
        <span class="keyword">this</span>.getSignificantFields(), that.getSignificantFields()
      );
    }
    <span class="keyword">return</span> result;
  }
  
  <span class="keyword">@Override</span> <span class="keyword">public</span> <span
            class="keyword">int</span> hashCode(){
    <span class="keyword">if</span> (fHashCode == <span class="literal">0</span>){
      fHashCode = ModelUtil.hashCodeFor(getSignificantFields());
    }
    <span class="keyword">return</span> fHashCode;
  }
  
  <span class="comment">// PRIVADO
</span>  <span class="keyword">private</span> <span class="keyword">final</span> Id fId;
  <span class="keyword">private</span> <span class="keyword">final</span> SafeText fName;
  <span class="keyword">private</span> <span class="keyword">final</span> SafeText fLocation;
  <span class="keyword">private</span> <span class="keyword">final</span> Decimal fPrice;
  <span class="keyword">private</span> <span class="keyword">final</span> SafeText fComment;
  <span class="keyword">private</span> <span class="keyword">int</span> fHashCode;
  
  <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> Decimal HUNDRED = Decimal.from(<span
            class="literal">"100"</span>);

  <span class="keyword">private</span> <span class="keyword">void</span> validateState() <span
            class="keyword">throws</span> ModelCtorException {
    ModelCtorException ex = <span class="keyword">new</span> ModelCtorException();
    <span class="keyword">if</span> (FAILS == Check.optional(fId, Check.range(<span
            class="literal">1</span>,<span class="literal">50</span>))) {
      ex.add(<span class="literal">"Id es opcional, 1..50 caracteres."</span>);
    }
    <span class="keyword">if</span> (FAILS == Check.required(fName, Check.range(<span
            class="literal">2</span>,<span class="literal">50</span>))) {
      ex.add(<span class="literal">"Se requiere el nombre del Restaurante, 2..50 caracteres."</span>);
    }
    <span class="keyword">if</span> (FAILS == Check.optional(fLocation, Check.range(<span
            class="literal">2</span>,<span class="literal">50</span>))) {
      ex.add(<span class="literal">"La ubicación es opcional, 2..50 caracteres."</span>);
    }
    Validator[] priceChecks = {Check.range(ZERO, HUNDRED), Check.numDecimalsAlways(<span
            class="literal">2</span>)};
    <span class="keyword">if</span> (FAILS == Check.optional(fPrice, priceChecks)) {
      ex.add(<span class="literal">"El precio es opcional, 0.00 a 100.00."</span>);
    }
    <span class="keyword">if</span> (FAILS == Check.optional(fComment, Check.range(<span
            class="literal">2</span>,<span class="literal">50</span>))) {
      ex.add(<span class="literal">"El comentario es opcional, 2..50 caracteres."</span>);
    }
    <span class="keyword">if</span> ( ! ex.isEmpty() ) <span
            class="keyword">throw</span> ex;
  }
  
  <span class="keyword">private</span> Object[] getSignificantFields(){
    <span class="keyword">return</span> <span class="keyword">new</span> Object[] {fName, fLocation, fPrice, fComment};
  }
}
 
    </pre>
    <br />
    <b>Ejemplo 2</b>
    <p></p>
    <p>
      Aquí tiene un ejemplo de una clase mutable, <code>Serializable</code> que define clases invariantes.
    </p>
    <p>
      Elementos a tener en cuenta:
    </p>
    <ul>
      <li>la aserción al final del método <code>close</code></li>
      <li>la llamada a <code>validateState</code> al final del método <code>readObject</code></li>
      <li>la implementación es significativamente más compleja, ya que la clase es mutable</li>
    </ul>
    <br />
    <pre>
<span class="keyword">import</span> java.text.StringCharacterIterator;
<span class="keyword">import</span> java.util.*;
<span class="keyword">import</span> java.io.*;

<span class="comment">/**
* En este estilo de implementación, tanto el estado entero del objeto 
* como sus campos individuales son validados sin duplicar ningún código.
*
* La validación de argumentos usualmente tiene if's y lanza excepciones al 
* inicio de un método. Aquí, estas son reemplazadas con una llamada simple a 
* validateXXX. La validación se separa claramente 
* del camino regular de ejecución, mejorando la legibilidad.
* JDK 7+.
*/</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span
            class="keyword">class</span> BankAccount <span
            class="keyword">implements</span> Serializable {

   <span class="comment">/**
   * @param aFirstName contiene solo letras, espacios, y apóstrofes.
   * @param aLastName contiene solo letras, espacios, y apóstrofes.
   * @param aAccountNumber es no negativo.
   *
   * @throws IllegalArgumentException si cualquier parámetro no es correcto.
   */</span>
   <span class="keyword">public</span> BankAccount(String aFirstName, String aLastName, <span
            class="keyword">int</span> aAccountNumber) {
      <span class="comment">//no llamar a un método sobreescribible en un cosntructor
</span>      setFirstName(aFirstName);
      setLastName(aLastName);
      setAccountNumber(aAccountNumber);
   }

   <span class="comment">/**
   * Todos los constructores "secundarios" llaman al constructor "primario", de forma que 
   * las validaciones son realizadas siempre.
   */</span>
   <span class="keyword">public</span> BankAccount() {
      <span class="keyword">this</span>(<span class="literal">"FirstName"</span>, <span
            class="literal">"LastName"</span>, <span class="literal">0</span>);
   }

   <span class="keyword">public</span> String getFirstName() {
     <span class="keyword">return</span> fFirstName;
   }

   <span class="keyword">public</span> String getLastName(){
    <span class="keyword">return</span> fLastName;
   }

   <span class="keyword">public</span> <span class="keyword">int</span> getAccountNumber() {
    <span class="keyword">return</span> fAccountNumber;
   }

   <span class="comment">/**
   * Este método cambia el estado internamente, y puede usar una aserción para 
   * implementar una post-condición sobre el estado del objeto.
   */</span>
   <span class="keyword">public</span> <span class="keyword">void</span> close(){
     <span class="comment">//válido:
</span>     fAccountNumber = <span class="literal">0</span>;

     <span class="comment">//este valor inválido dispará la aserción:
</span>     <span class="comment">//fAccountNumber = -2;
</span>
     assert hasValidState(): <span class="keyword">this</span>;
   }

   <span class="comment">/**
   * Los nombres deben contener solo letras, espacios, y apóstrofes.
   *
   * @throws IllegalArgumentException si cualquier parámetro no cumple.
   */</span>
   <span class="keyword">public</span> <span class="keyword">void</span> setFirstName(String aNewFirstName) {
      validateName(aNewFirstName);
      fFirstName = aNewFirstName;
   }

   <span class="comment">/**
   * Los nombres deben contener solo letras, espacios, y apóstrofes.
   *
   * @throws IllegalArgumentException si cualquier parámetro no cumple.
   */</span>
   <span class="keyword">public</span> <span class="keyword">void</span> setLastName (String aNewLastName) {
      validateName(aNewLastName);
      fLastName = aNewLastName;
   }

   <span class="comment">/**
   * AccountNumber debe ser no negativa.
   *
   * @throws IllegalArgumentException si cualquier parámetro no cumple.
   */</span>
   <span class="keyword">public</span> <span class="keyword">void</span> setAccountNumber(<span
            class="keyword">int</span> aNewAccountNumber) {
      validateAccountNumber(aNewAccountNumber);
      fAccountNumber = aNewAccountNumber;
   }

   <span class="comment">/**
   * Puede ser usada para pasar facilmente la descripción de un objeto a una aserción,
   * usando una referencia "this".
   */</span>
   <span class="keyword">public</span> String toString(){
     <span class="keyword">final</span> StringBuilder result = <span
            class="keyword">new</span> StringBuilder();
     <span class="keyword">final</span> String SPACE = <span
            class="literal">" "</span>;
     result.append(fFirstName);
     result.append(SPACE);
     result.append(fLastName);
     result.append(SPACE);
     result.append(fAccountNumber);
     <span class="keyword">return</span> result.toString();
   }

   <span class="comment">// PRIVADO
</span>
   <span class="keyword">private</span> String fFirstName;
   <span class="keyword">private</span> String fLastName;
   <span class="keyword">private</span> <span class="keyword">int</span> fAccountNumber;

   <span class="comment">/**
   * Verifica que todos los campos de este objeto toman valores permisibles; es decir,
   * este método define la clase invariante.
   *
   * Llamar después de la deserialización.
   * @throws IllegalArgumentException si cualquier campo toma un valor no permitido.
   */</span>
   <span class="keyword">private</span> <span class="keyword">void</span> validateState() {
      validateAccountNumber(fAccountNumber);
      validateName(fFirstName);
      validateName(fLastName);
   }

   <span class="comment">/**
   * Devuelve verdadero si &lt;code&gt;validateState&lt;/code&gt; no lanza 
   * una IllegalArgumentException, de otra forma devuelve falso.
   *
   * Llamar al final de cualquier método público que ha cambiado el 
   * estado (cualquier método "mutador"). Esto es usualmente hecho en 
   * una aserción, ya que corresponde a una post condición.
   * Por ejemplo,
   * &lt;pre&gt;
   * assert hasValidState() : this;
   * &lt;/pre&gt;
   * Este método es proporcionado desde &lt;code&gt;validateState&lt;/code&gt; no puede ser usada 
   * en una aserción.
   */</span>
   <span class="keyword">private</span> <span class="keyword">boolean</span> hasValidState() {
     <span class="keyword">boolean</span> result = <span class="keyword">true</span>;
     <span class="keyword">try</span> {
       validateState();
     }
     <span class="keyword">catch</span> (IllegalArgumentException ex){
       result = <span class="keyword">false</span>;
     }
     <span class="keyword">return</span> result;
   }

   <span class="comment">/**
   * Asegurar los nombres contiene solo letras, espacios, y apóstrofes.
   *
   * @throws IllegalArgumentException si un argumento no cumple.
   */</span>
   <span class="keyword">private</span> <span class="keyword">void</span> validateName(String aName){
     <span class="keyword">boolean</span> nameHasContent = (aName != <span
            class="keyword">null</span>) &amp;&amp; (!aName.equals(<span
            class="literal">""</span>));
     <span class="keyword">if</span> (!nameHasContent){
       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span
            class="literal">"Los nombres deben ser no nulos y no vacíos."</span>);
     }
     StringCharacterIterator iterator = <span class="keyword">new</span> StringCharacterIterator(aName);
     <span class="keyword">char</span> character =  iterator.current();
     <span class="keyword">while</span> (character != StringCharacterIterator.DONE ){
       <span class="keyword">boolean</span> isValidChar = (Character.isLetter(character)
                             || Character.isSpaceChar(character)
                             || character ==<span class="literal">'\''</span>);
       <span class="keyword">if</span> (isValidChar) {
         <span class="comment">//no hace nada
</span>       }
       <span class="keyword">else</span> {
         String message = <span class="literal">"Los nombres pueden contener solo letras, espacios, y apóstrofes."</span>;
         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(message);
       }
       character = iterator.next();
     }
  }

  <span class="comment">/**
  * AccountNumber debe ser no negativo.
  *
  * @throws IllegalArgumentException si el argumento no cumple.
  */</span>
   <span class="keyword">private</span> <span class="keyword">void</span> validateAccountNumber(<span
            class="keyword">int</span> aAccountNumber){
      <span class="keyword">if</span> (aAccountNumber &lt; <span
            class="literal">0</span>) {
        String message = <span class="literal">"El Número de Cuenta debe ser mayor que o igual a 0."</span>;
        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(message);
      }
   }

   <span class="keyword">private</span> <span class="keyword">static</span> <span
            class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span
            class="literal">7526472295622776147L</span>;

   <span class="comment">/**
   * Siempre trata la deserialización como un constructor en toda regla, al 
   * validar el estado final del objeto deserializado.
   */</span>
   <span class="keyword">private</span> <span class="keyword">void</span> readObject(ObjectInputStream aInputStream)
                                <span class="keyword">throws</span> ClassNotFoundException, IOException {
     <span class="comment">//siempre realiza la deserialización predeterminada primero
</span>     aInputStream.defaultReadObject();

     <span class="comment">//asegura que el estado de objeto no ha sido corrompido o 
</span>     <span class="comment">//manipulado maliciosamente
</span>     validateState();
  }

  <span class="comment">/** Prueba simple.  */</span>
  <span class="keyword">public</span> <span class="keyword">static</span> <span
            class="keyword">void</span> main (String... aArguments) {
    BankAccount account = <span class="keyword">new</span> BankAccount(<span
            class="literal">"Joe"</span>, <span class="literal">"Strummer"</span>, <span
            class="literal">532</span>);
    <span class="comment">//ejercer validaciones específicas.
</span>    account.setFirstName(<span class="literal">"John"</span>);
    account.setAccountNumber(<span class="literal">987</span>);
    <span class="comment">//ejercitar la afirmación posterior a la condición
</span>    <span class="comment">//requiere que se habiliten las aserciones: "java -ea"
</span>    account.close();

    <span class="comment">//ejercita la serialización
</span>    <span class="keyword">try</span> (
      OutputStream file = <span class="keyword">new</span> FileOutputStream(<span
            class="literal">"account.ser"</span>);
      OutputStream buffer = <span class="keyword">new</span> BufferedOutputStream(file);
      ObjectOutput output = <span class="keyword">new</span> ObjectOutputStream(buffer);
    ){
      output.writeObject(account);
    }
    <span class="keyword">catch</span>(IOException exception){
      System.err.println(exception);
    }

    <span class="comment">//ejercita la deserialización
</span>    <span class="keyword">try</span> (
      InputStream file = <span class="keyword">new</span> FileInputStream(<span
            class="literal">"account.ser"</span>);
      InputStream buffer = <span class="keyword">new</span> BufferedInputStream(file);
      ObjectInput input = <span class="keyword">new</span> ObjectInputStream(buffer);
    ){
      BankAccount recoveredAccount = (BankAccount)input.readObject();
      System.out.println(<span class="literal">"Cuenta recuperada: "</span> + recoveredAccount);
    }
    <span class="keyword">catch</span>(IOException | ClassNotFoundException exception ){
      System.err.println(exception);
    }
  }
} 
    </pre>
    <br />
    <p></p>
    <div class="topic-section" id="see-also-title">Vea También :</div>
    <div id="see-also" class="main-body">
      <a href="..\practicascomunes\practicascomunes_5.html">Valide los argumentos del método</a><br />
      <a href="..\patrones\patrones_29.html">Objetos inmutables</a><br />
      <a href="..\serializacion\serializacion_45.html">Implementar Serializable</a><br /> 
      <a href="..\practicascomunes\practicascomunes_64.html">Compilación condicional</a><br /> 
      <a href="..\aserciones\aserciones_100.html">La aserción es sólo para argumentos privados</a><br />
      <a href="..\aserciones\aserciones_102.html">Casos de uso de las aserciones</a> <br /> 
      <a href="..\patrones\patrones_187.html">Objetos Modelo</a> <br />
    </div>
    <footer id="footer" class="legalese">
      <span id="app_name">Prácticas de Java</span> 
      <span id="app_version_number">3.001</span><br /> © 
      <span id="copyright">2018 Hirondelle Systems</span><br /> 
      <a href="http://www.javapractices.com/source/SourceAction.do">Código Fuente</a> | 
      <a href="mailto:webmaster@javapractices.com" rel="author">Contacto</a> | 
      <a href="http://creativecommons.org/licenses/by-nc-sa/1.0/" rel="license">Licencia</a> | 
      <a href="http://www.javapractices.com/apps/cjp.rss" rel="alternate" type="application/rss+xml">RSS</a>
      <!-- ukey="2AC36CD2" -->
      <!-- ckey="16DF3D87" -->
      <br /> Los trozos de código individual tienen una 
      <a href="http://www.javapractices.com/LICENSE.txt" rel="license">licencia BSD</a><br /> 
      Sobre 1,000,000 de IPs únicas el último año<br /> 
      Última actualización <time id="last_updated_on" datetime="2018-06-03">2018-06-03</time><br />
      - In Memoriam : Bill Dirani -
    </footer>
  </body>
</html>